---
title: "Lesion manuscript outline"
author: "Jackie Ernest"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      message = F, 
                      warning = F, 
                      fig.height = 3.75, 
                      fig.width = 6.5, 
                      fig.pos = "H",
                      out.extra = "")

options(ggplot2.discrete.colour= c("#00AFBB", "#E7B800", "#FC4E07", "grey"),
        ggplot2.discrete.fill= c("#00AFBB", "#E7B800", "#FC4E07", "grey"))

set.seed(3)

#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
setwd("~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Clinical_validation/R_scripts/")

library(tidyverse)
library(xpose)
library(xpose4)
library(ggpubr)
library(gridExtra)
library(grid)
library(readxl)
library(ggsci)
library(patchwork)
library(scales)
library(vpc)
library(viridis)
library(savictools)

theme_set(theme_bw(base_size=14)+theme(legend.title=element_blank()))

WD <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/"
wd_hum <- "Clinical_validation/Validation_set_human/"
wd_rab <- "Clinical_validation/Validation_set_rabbit/"
wd_fig <- "Clinical_validation/R_scripts/for_gh_upload/results/"
wd_r <- "Clinical_validation/R_scripts"
wd_clin_update <- "Clinical_validation/Validation_set_human/nonmem/LCM/ClinicalPK_updates_from_AnnaFochesato_20230504/"


#setwd(paste0(WD,wd_rab))

LESIONGROUP_levels <- c("Plasma", 
                        "Lung", 
                        "Cellular", 
                        "Caseum", 
                        "Caseous/Fibrotic", 
                        "Cavity", 
                        "Lymph Node", 
                        "Foamy Macrophage", 
                        "Blood",
                        "Misc",
                        "Review")

lesion_level <- c("Plasma",
                  "Lung", 
                  "Cellular lesion", 
                  "Caseum", 
                  "Cavity wall", 
                  "Caseous lesion")

COLOR_map <- c("#332288",
               "#88CCEE",
               "#44AA99",
               "#117733",
               "#999933",
               "#DDCC77",
               "#CC6677",
               "#882255",
               "#AA4499",
               "#DDDDDD",
               "#332288",
               "#88CCEE",
               "#44AA99",
               "#117733")

`%notin%` <- Negate(`%in%`)

##### for common legend in ggarrange:
get_only_legend <- function(plot) {
        # get tabular interpretation of plot
        plot_table <- ggplot_gtable(ggplot_build(plot)) 
        #  Mark only legend in plot
        legend_plot <- which(sapply(plot_table$grobs, function(x) x$name) == "guide-box") 
        # extract legend
        legend <- plot_table$grobs[[legend_plot]]
        # return legend
        return(legend) 
}
```

# Import data

## Import drug potency
```{r}
drug_potency_MRT2 <- read.csv("drug_potency_table.csv")
```

## Import human raw data

```{r}
all_human_obs <- read.csv("human_lesion_pk.csv")
```

## Import rabbit raw data

```{r}
all_rabbit_obs <- read.csv("rabbit_lesion_pk.csv")
```

# Data visualization

## Supplementary Table 1. Data Available

```{r}

table1 <- left_join(
  
  # Number of subjects per drug
  all_rabbit_obs %>% 
    distinct(DRUG, CID) %>% 
    group_by(DRUG) %>% 
    summarise(Subject_N = n()), 
  
  # Number of plasma samples
  all_rabbit_obs %>% 
    filter(LESIONGROUP == "Plasma") %>% 
    group_by(DRUG, LESIONGROUP) %>% 
    summarise(count = n()) %>% 
    pivot_wider(names_from = LESIONGROUP, values_from = count)) %>% 
  left_join(.,
  
  # Number of lesion samples
  all_rabbit_obs %>% 
    filter(LESIONGROUP != "Plasma") %>% 
    mutate(LESIONGROUP = "Lesion") %>% 
    group_by(DRUG, LESIONGROUP) %>% 
    summarise(count = n()) %>% 
    pivot_wider(names_from = LESIONGROUP, values_from = count)
  )

# write.csv(table1, paste0(WD,wd_fig,format(Sys.Date(), "%Y%m%d"),"_Table1.csv"), row.names = F)

table1_human <- left_join(
  
  # Number of subjects per drug
  all_human_obs %>% 
    distinct(DRUG, CID) %>% 
    group_by(DRUG) %>% 
    summarise(Subject_N = n()), 
  
  # Number of plasma samples
  all_human_obs %>% 
    filter(LESIONGROUP == "Plasma") %>% 
    group_by(DRUG, LESIONGROUP) %>% 
    summarise(count = n()) %>% 
    pivot_wider(names_from = LESIONGROUP, values_from = count)) %>% 
  left_join(.,
  
  # Number of lesion samples
  all_human_obs %>% 
    filter(LESIONGROUP != "Plasma") %>% 
    mutate(LESIONGROUP = "Lesion") %>% 
    group_by(DRUG, LESIONGROUP) %>% 
    summarise(count = n()) %>% 
    pivot_wider(names_from = LESIONGROUP, values_from = count)
  )

table1_combine <- bind_rows(table1_human %>% mutate(Species = "Human", .before = DRUG),
                            table1 %>% mutate(Species = "Rabbit", .before = DRUG))

#write.csv(table1_combine, "./results/STab1.csv", row.names = F)

# number of observations total:
table1_combine %>% 
  filter(DRUG %in% drug_list) %>% 
  summarise(sumN = sum(Subject_N),
            sum_plasma = sum(Plasma),
            sum_lesion = sum(Lesion)) %>% 
  mutate(n_total = sum_plasma + sum_lesion)

# average number of subjects for 7 drugs
table1_combine %>%  
  filter(DRUG %in% drug_list) %>% 
  filter(Species == "Rabbit") %>% 
  summarise(sumN = sum(Subject_N)) %>% 
  mutate(N_avg = sumN/7)
```

## Supplementary Table 4. In vitro data used

```{r}

drug_potency_MRT2 %>% 
  select(-LESIONNAME, -MRT_mgL) %>% 
  distinct() %>% 
  filter(DRUG %notin% c( "SQ109", "INH_s", "INH_i", "INH_f", "TBI-223-M2")) %>% 
  select(DRUG, contains("_mgL")) %>% 
  #mutate_if(is.numeric, round, 2) %>% 
  mutate(casMBC50_mgL_char_7 = ifelse(DRUG %in% c("BDQ", "BDQ-M2", 
                                                  "TBAJ-587", "TBAJ-587-M3", 
                                                  "TBAJ-876", "TBAJ-876-M3"),
                                  casMBC50_mgL_char_14,
                                  casMBC50_mgL_char_7)) %>% 
  mutate(casMBC90_mgL_char_7 = ifelse(DRUG %in% c("BDQ", "BDQ-M2", 
                                                  "TBAJ-587", "TBAJ-587-M3", 
                                                  "TBAJ-876", "TBAJ-876-M3"),
                                casMBC90_mgL_char_14,
                                casMBC90_mgL_char_7)) %>% 
  rename(casMBC50_mgL     = casMBC50_mgL_char_7) %>% 
  rename(casMBC90_mgL_old = casMBC90_mgL) %>% 
  rename(casMBC90_mgL     = casMBC90_mgL_char_7) %>% 
  select(DRUG, MIC_mgL, macIC90_mgL, casMBC50_mgL, casMBC90_mgL) %>% 
  arrange(DRUG) %>% View()

# write.csv(., paste0(WD,wd_fig,format(Sys.Date(), "%Y%m%d"),"_SuppTable1_w.o_rounding.csv"), row.names=F)
```

## Supplementary Figure 2. Raw data for humans by method

```{r warning=F, fig.width=10, fig.height=10}

Human_PK_plot_1A <- lapply(all_human_obs$DRUG %>% unique(), function(drug){
  
  all_human_obs %>% 
    filter(DRUG == drug) %>% 
    filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
    mutate(LESIONGROUP = factor(LESIONGROUP, 
                                levels = c("Plasma", "Lung", 
                                           "Cellular", "Caseum"))) %>% 
    ggplot(mapping = aes(x = TIME, y = DV, color = METHOD, group = METHOD))+
    geom_point(size = 1, alpha = 0.2)+
    # stat_summary(geom="line", fun = median)+
    stat_summary_bin(geom="line", fun = "median",breaks = c(-0.1, 4, 8, 12, 20, 24, 38), size=0.8)+
    facet_wrap(~LESIONGROUP, nrow=1)+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    ggtitle(drug)+
    scale_y_log10()+
    scale_x_continuous(breaks = seq(0, 36, 6), limits = c(0,NA))+
    # scale_color_jco()+
    scale_color_manual(values = c(COLOR_map[1], COLOR_map[2]))+
    theme_bw(base_size=10)+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          legend.text = element_text(size=7),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          # legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          legend.margin = margin(0,0,0,0),
          legend.direction = "vertical",
          legend.key.height = unit(0.005,'in'),
          legend.title = element_blank(),
          # legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 8),
          axis.title = element_blank(),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 9,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

})

tiff(paste0(WD, wd_fig, "SFig2.tiff", sep =""), width = 6.5, height = 8, res = 300, compression = 'lzw')
# pdf(paste0(WD, wd_fig, "SFig2.pdf"), width = 6.5, height = 8)

grid.arrange(grobs = Human_PK_plot_1A, nrow=7,
             bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=10)),
             left = textGrob("Concentration (mg/L or mg/kg)", gp=gpar(fontsize=10), rot = 90))

dev.off()

```

## Supplementary Figure 1

```{r}
both_species_slim_df_raw_data <- bind_rows(
  all_human_obs %>% 
    select(DRUG, CID, TAD, DV, LESIONNAME, LESIONGROUP, METHOD) %>% 
    mutate(SPECIES = "Clinical"),
  all_rabbit_obs %>% 
    filter(SET == "Validation") %>% 
    select(DRUG, CID, TAD, DV, LESIONNAME, LESIONGROUP, METHOD) %>% 
    mutate(METHOD = ifelse(METHOD==0, "LCMS", "LCM")) %>% 
    mutate(SPECIES = "Rabbit")
  ) %>% 
  mutate(METHOD = ifelse(LESIONGROUP == "Plasma", "LCMS", METHOD))
```

```{r}
Both_PK_plot_1 <- lapply(both_species_slim_df_raw_data$DRUG %>% unique(), function(drug){
  
  both_species_slim_df_raw_data %>% 
    filter(DRUG == drug) %>% 
    filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
       filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
    mutate(LESIONGROUP = factor(LESIONGROUP, 
                                levels = c("Plasma", "Lung", 
                                           "Cellular", "Caseum"))) %>% 
    ggplot(mapping = aes(x = TAD, y = DV, color = SPECIES, group = SPECIES))+
    geom_point(size = 1, alpha = 0.2)+
    # stat_summary(geom="line", fun = median)+
    stat_summary_bin(geom="line", fun = "median",breaks = c(-0.1, 4, 8, 12, 20, 24, 38, 54, 90), size=0.8)+
    facet_wrap(~LESIONGROUP, nrow=1)+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    ggtitle(drug)+
    scale_y_log10()+
    scale_x_continuous(breaks = seq(0, 72, 12), limits = c(0,NA))+
    scale_color_jco()+
    theme_bw(base_size = 9)+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          legend.text = element_text(size=7),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          legend.key.size = unit(0.1,'in'),
          # legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          legend.margin = margin(0,0,0,0.01),
          # legend.direction = "vertical",
          # legend.key.height = unit(0.005,'in'),
          legend.title = element_blank(),
          # legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 9),
          axis.title = element_blank(),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 9,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

})

tiff(paste0(WD, wd_fig, "SFig1.tiff", sep =""), width = 6.5, height = 8, res=300, compression = 'lzw')
# pdf(paste0(WD, wd_fig,"SFig1.pdf", sep =""), width = 6.5, height = 8)

grid.arrange(grobs = Both_PK_plot_1, nrow=7,
             bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=10)),
             left = textGrob("Concentration (mg/L or mg/kg)", gp=gpar(fontsize=10), rot = 90))

dev.off()
```

## Figure 2

```{r}
all_raw_data <- bind_rows(
  all_human_obs %>% 
    select(DRUG, CID, TAD, DV, LESIONNAME, LESIONGROUP, METHOD) %>% 
    mutate(SPECIES = "XClinical"),
  all_rabbit_obs %>% 
    select(DRUG, CID, TAD, DV, LESIONNAME, LESIONGROUP, METHOD) %>% 
    mutate(METHOD = ifelse(METHOD==0, "LCMS", "LCM")) %>% 
    mutate(SPECIES = "Rabbit")
) %>% 
  arrange(SPECIES) %>% 
  mutate(METHOD = ifelse(LESIONGROUP == "Plasma", "LCMS", METHOD))
```

```{r}

SPECIES_color_map <- c("XClinical" = "#FFA500",
                       "Rabbit" = "#0072C6",
                       "NA" = "grey")

All_data_plot <- lapply(all_raw_data$DRUG %>% unique(), function(drug){
  
  # x-axis breaks
  if(drug %in% c("CFZ", "BDQ", "BDQ-M2", "GSK-656", 
                 "TBAJ-587", "TBAJ-587-M3", "TBAJ-876", "TBAJ-876-M3")) {
    b <- seq(0, 120, 24)
  } else if(drug=="AMK") {
    b <- seq(0,24,2)
  } else if(drug=="TBI-223") {
    b <- seq(0,24,4)
  } else {
    b <- seq(0, 72, 6)
  }
  
  # y-axis breaks
  if(drug %in% c("CFZ","LZD","DLM", "BDQ", "BDQ-M2", "GSK-286", 
                 "SZD","SZD-M1","GTX","TBAJ-876", "TBAJ-876-M3")) {
    yb <- seq(-4,4,2)
  } else {
    yb <- seq(-4,4)
  }
  
  # stat summary bin breaks
  # if(drug ) {
  #   
  # } else {
  # c_breaks <- c(-0.1, 4, 8, 12, 20, 26, 38, 54, 90, 120)
  # }
  
  all_raw_data %>% 
    filter(DRUG == drug) %>% 
    filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
    mutate(STRT = paste(SPECIES, METHOD, sep = " ")) %>% 
    ggplot(mapping = aes(x = TAD, y = DV, 
                         color = SPECIES, 
                         group = SPECIES,#STRT, 
                         linetype = NULL,#STRT, 
                         shape = NULL ))+ #STRT))+
    geom_point(size = 1.1, alpha = 0.3)+
    # stat_summary(geom="line", fun = median)+
    stat_summary_bin(geom="line", fun = "median", size=0.3)+#breaks = c_breaks,
    facet_grid(~LESIONGROUP)+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    #ggtitle(drug)+
    ylab(drug)+
    scale_y_continuous(#sec.axis = sec_axis( trans=~.*1),
                       trans = log10_trans(),
                       breaks = trans_breaks("log10", function(x) ifelse(10^x %in% c(10**yb), 10^x, NA )),
                       #labels = trans_format("log10", function(x) ifelse(x %in% c(yb), math_format(10^.x), NULL)),
                       labels = trans_format("log10", math_format(10^.x)),
                       sec.axis = dup_axis(name = NULL))+
    scale_x_continuous(breaks = b, limits = c(0,NA))+
    scale_color_manual(values = SPECIES_color_map)+ 
    scale_linetype_manual(values = c(2,1,2,1,1))+
    scale_shape_manual(values = c(1,2,1,2,1))+
    theme_bw()+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          legend.text = element_text(size=5),
          legend.justification = c(1, 1),
          legend.spacing.y = unit(0, 'cm'),
          #legend.position = c(1, 0.98),
          legend.key.size = unit(0.1,'in'),
          # legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          legend.margin = margin(0,0,0,0.01),
          legend.direction = "vertical",
          legend.key.height = unit(0.005,'in'),
          legend.title = element_blank(),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text.x = element_text(size = 5),
          axis.text.y = element_text(size = 6),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 6),
          strip.text.x = element_blank(),
          plot.title = element_text(size = 6,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

})

# All_data_plot <- append(All_data_plot, list("leg" = legend))

tiff(paste0(WD, wd_fig, "Fig.tiff", sep =""), width = 6.6, height = 8.1, res=300, compression = 'lzw')
# pdf(paste0(WD, wd_fig, "Fig2.pdf", sep =""), width = 6.6, height = 8.1)

grid.arrange(
            # 1st column
            arrangeGrob(grobs = All_data_plot[1:14], ncol=1,
            bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=8)),
            left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=8), rot = 90)),
            # 2nd column
            arrangeGrob(grobs = All_data_plot[15:28], ncol=1,
            bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=8)),
            left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=8), rot = 90)),
            ncol=2
            )

dev.off()

```

# Model Parameters

# Load final lesion model parameters
Human and rabbit
### 1. Human lesion parameters rate (K) and ratio (PC)
```{r}
# ANNOTATE: what lesion based on manuscript labelling is used?
# Current parameters are from Strydom N et al. PLoS Med (2019).
# eventually need to incorporate Anna Fochesato's updated parameters that include LCM

lesion_pk_params_hum <- read.table(text = "drug	hu_KPL_lung	hu_KPL_cell	hu_KPL_cavity_wall	hu_KPL_caseous	hu_KPL_caseum	hu_PC_lung	hu_PC_cell	hu_PC_cavity_wall	hu_PC_caseous	hu_PC_caseum
RIF	1.68	4.67	1.98	0.367	0.204	0.694	0.348	0.614	0.733	0.449
INH_s	0.625	0.68	0.173	0.168	0.148	0.552	0.228	0.175	0.516	0.298
INH_i	0.625	0.68	0.173	0.168	0.148	0.552	0.228	0.175	0.516	0.298
INH_f	0.625	0.68	0.173	0.168	0.148	0.552	0.228	0.175	0.516	0.298
PZA	1.8	7.34	1.52	1.28	0.818	0.616	0.698	0.72	0.611	0.544
MXF	0.276	5.78	0.476	0.348	0.21	4.41	1.34	2.33	2.41	1.26
CFZ	4.32	2.86	3.21	2.75	2.74	12.4	11.47	11.3	14.3	1.34
KAN	0.29	0.133	0.186	0.212	0.128	0.404	0.422	0.468	0.503	0.468
LZD	0.152	0.001	0.305	0.275	0.427	0.609	0.531	0.497	0.177	0.651", header = TRUE)

```

#### 1b. Human lesion parms updated

From collect_clinical_PK_parms.R

```{r}
index <- tibble(drug_list = c("CFZ", "INH", "KAN", "LZD", "MXF", "PZA", "RIF")) %>% 
  cross_join(., tibble(LESIONNAME = c("Plasma","Uninvolved_Lung", "Cellular_Lesion", "Caseum")))

param_all <- NULL
for (i in 1:dim(index)[1]) {
  
  print(paste0(index$drug_list[i], index$LESIONNAME[i]))
  
  setwd(paste0(WD,wd_clin_update,"/",index$drug_list[i], "/Final_models_estimates_JE/", index$LESIONNAME[i],"/"))
  
  lst <- list.files(pattern = "\\.lst$")
  
  param <- param_table(runno=lst, nice = F) %>% 
    mutate(DRUG = index$drug_list[i],
           LESIONNAME = index$LESIONNAME[i])
  
  param_all <- bind_rows(param_all, param)
}

clinical_updated_PCs <- param_all %>% 
  filter(Description == "R") %>% 
  mutate(Value = as.numeric(Value)) %>% 
  # to match parms_val_set
  mutate(drug = DRUG) %>% 
  mutate(lesion = case_when(LESIONNAME == "Uninvolved_Lung" ~ "Normal lung",
                                LESIONNAME == "Cellular_Lesion" ~ "Cellular Lesion",
                                .default = LESIONNAME)) %>% 
  select(-LESIONNAME)

```


### 2. Rabbit lesion parameters rate (K) and ratio (PC) from rabbit with model reference
```{r}

# Migrated from ~/Dartois_collaboration/method_paper/r_scripts/clinical_lesion_PK_simulations/all_drug_param_table.xlsx (20230609)
# use NA to maintain spacing

lesion_pk_params_rab <- read.table(text = "drug	rab_KPL_lung	rab_KPL_cell	rab_KPL_cavity_wall	rab_KPL_caseous	rab_KPL_caseum	rab_PC_lung	rab_PC_cell	rab_PC_cavity_wall	rab_PC_caseous	rab_PC_caseum	rab_lung_runno	rab_cell_runno	rab_cavity_wall_runno	rab_caseous_runno	rab_caseum_runno
RIF	1.67	1.06	1.36	5.03	0.0656	0.872	0.647	0.691	1.05	2.61	NA	NA	NA	NA	NA
INH_s	0.294	0.0583	NA	NA	0.102	1.32	1.15	NA	NA	0.344	NA	NA	NA	NA	NA
INH_i	0.294	0.0583	NA	NA	0.102	1.32	1.15	NA	NA	0.344	NA	NA	NA	NA	NA
INH_f	0.294	0.0583	NA	NA	0.102	1.32	1.15	NA	NA	0.344	NA	NA	NA	NA	NA
PZA	NA	NA	NA	NA	NA	0.479	0.51	0.724	NA	0.502	NA	NA	NA	NA	NA
MXF	1	0.997	0.726	1.29	10	4.58	8.01	6.14	7.18	3.39	NA	NA	NA	NA	NA
CFZ	10	10	10	10	10	130.4	235.6	NA	NA	2.07	NA	NA	NA	NA	NA
KAN	0.493	0.419	NA	0.448	0.395	0.386	0.527	NA	0.481	0.331	NA	NA	NA	NA	NA
LZD	10	10	10	NA	10	1.04	0.97	1.05	NA	1.02	NA	NA	NA	NA	NA
BDQ	10	0.141	NA	NA	10	133	81.3	NA	NA	4.95	NA	NA	NA	NA	NA
TBAJ-587	10	10	NA	NA	10	89.8	148	NA	NA	5.1	NA	NA	NA	NA	NA
TBAJ-876	0.1629	0.08593	NA	NA	0.03149	113.5	151.5	NA	NA	4.754 NA	NA	NA	NA	NA
TBAJ-876-M3	0.02227	0.02328	NA	NA	0.001451	1117	1012	NA	NA	67.36 NA	NA	NA	NA	NA
PMD	2.52	10	10	10	10	4.18	4.14	2.66	4.46	4.2	NA	NA	NA	NA	NA
DLM	2.63	10	NA	0.54	10	8.06	9.22	NA	17.6	1.14	NA	NA	NA	NA	NA
SZD	0.1317	0.2375	NA	NA	0.5334	0.4438	0.5136	NA	NA	0.6626	27	30	NA	NA	31
SZD-M1	0.1317	0.2375	NA	NA	0.5334	0.4438	0.5136	NA	NA	0.6626	27	30	NA	NA	31
TBI-223	10	10	NA	NA	1.72	1.01	1.12	NA	NA	1.49	NA	NA	NA	NA	NA
OPC-167832	10	10	NA	NA	0.393	1.75	1.94	NA	NA	1.60	NA	NA	NA	NA	NA
GSK-656	10	10	NA	NA	10	1.10	1.88	NA	NA	0.77	L01b	L02c	NA	NA	L03c
RPT	10	1.86	0.63	NA	234	0.71	1.1	1.01	NA	0.25	savic2017	savic2017	NA	NA	savic2017", header = T) %>% 
  
  mutate(rab_cavity_wall_runno = as.character(rab_cavity_wall_runno)) %>% 
  mutate(rab_caseous_runno = as.character(rab_caseous_runno)) %>% 
  
  # Jackie remodels PZA (PZA_rabbit_PK/nm/archive)
  rows_upsert(., tibble(
    drug = "PZA",
    rab_KPL_lung          = 0.544,
    rab_KPL_cell          = 0.88,
    rab_KPL_cavity_wall   = 1.01,
    rab_KPL_caseum        = 0.616,
    rab_PC_lung           = 1.1,
    rab_PC_cell           = 0.859,
    rab_PC_cavity_wall    = 1.49,
    rab_PC_caseum         = 0.852,
    rab_lung_runno        = "L10",
    rab_cell_runno        = "L13",
    rab_cavity_wall_runno = "L15",
    rab_caseum_runno      = "L17"
  )) %>% 
  
  # Jackie updates INH (INH_rabbit_PK/nm/final)
  filter(drug %notin% c("INH_s", "INH_f", "INH_i")) %>% 
  rows_upsert(., tibble(
    drug = c("INH_s", "INH_f", "INH_i"),
    rab_KPL_lung          = 0.29,
    rab_KPL_cell          = 0.06,
    rab_KPL_caseum        = 0.47,
    rab_PC_lung           = 1.32,
    rab_PC_cell           = 1.15,
    rab_PC_caseum         = 1.09,
    rab_lung_runno        = "",
    rab_cell_runno        = "",
    rab_caseum_runno      = ""
  )) %>% 
  
  # Jackie adds GTX
  rows_insert(., tibble(
    drug = "GTX",
    rab_KPL_lung          = 0.699,
    rab_KPL_cell          = 1.01,
    rab_KPL_caseum        = 10,
    rab_PC_lung           = 7.49,
    rab_PC_cell           = 8.97,
    rab_PC_caseum         = 4.62,
    rab_lung_runno        = "run121_1a_linear",
    rab_cell_runno        = "run121_2a_linear",
    rab_caseum_runno      = "run121_3a_linear"
  )) %>% 
  
  # Jackie updates SZD-M1
  rows_upsert(., tibble(
    drug = "SZD-M1",
    rab_KPL_lung          = 0.299,
    rab_KPL_cell          = 0.228,
    rab_KPL_caseum        = 0.247,
    rab_PC_lung           = 0.904,
    rab_PC_cell           = 1.01,
    rab_PC_caseum         = 0.987
  )) %>% 
  
  # Jackie adds new PMD
  filter(drug != "PMD") %>% 
  rows_insert(., tibble(
    drug = "PMD",
    rab_KPL_lung          = 2.44,
    rab_KPL_cell          = 10,
    rab_KPL_caseum        = 10,
    rab_PC_lung           = 4.59,
    rab_PC_cell           = 4.56,
    rab_PC_caseum         = 2.16,
    rab_lung_runno        = "L01",
    rab_cell_runno        = "L02a",
    rab_caseum_runno      = "L03b"
  )) %>% 

  # Jackie matches KAN with 2021 paper
  filter(drug != "KAN") %>% 
  rows_insert(., tibble(
    drug = "KAN",
    rab_KPL_lung             = 0.493,
    rab_KPL_cell             = 0.419,
    rab_KPL_caseous          = 0.448,
    rab_KPL_caseum           = 0.395,
    rab_PC_lung              = 0.338,
    rab_PC_cell              = 0.454,
    rab_PC_caseous           = 0.476,
    rab_PC_caseum            = 0.497,
    rab_lung_runno           = "L01x",
    rab_cell_runno           = "L02e",
    rab_caseous_runno        = "L03d",
    rab_caseum_runno         = "L04g"
  )) %>% 
  
  # Jackie adds AMK
  rows_insert(., tibble(
    drug = "AMK",
    rab_KPL_lung             = 0.716,
    rab_KPL_cell             = 0.385,
    rab_KPL_caseous          = 0.490,
    rab_KPL_caseum           = 0.496,
    rab_PC_lung              = 0.437,
    rab_PC_cell              = 0.462,
    rab_PC_caseous           = 0.618,
    rab_PC_caseum            = 0.927,
    rab_lung_runno           = "L01c",
    rab_cell_runno           = "L02c",
    rab_caseous_runno        = "L03c",
    rab_caseum_runno         = "L04c"
  )) %>% 
  
  # Jackie adds EMB (Zimmerman, Lestner, et al AAC 2017)
  # Note: 3 lesion compartments were lung, cellular lesion, and caseuous lesion
  # For the purpose of having an estimate in caseum, let's assume it's equal to caseous lesion
  rows_insert(., tibble(
    drug = "EMB",
    rab_KPL_lung             = 8.1,  #kcl
    rab_KPL_cell             = 7.52, #kccell
    rab_KPL_caseous          = 2.44, #kccas
    rab_KPL_caseum           = 2.44, #kccas
    rab_PC_lung              = 3.90, #Rcl
    rab_PC_cell              = 3.33, #Rccell
    rab_PC_caseous           = 2.41, #Rccas
    rab_PC_caseum            = 2.41,
    rab_lung_runno           = "Zimmerman_AAC_2017",
    rab_cell_runno           = "Zimmerman_AAC_2017",
    rab_caseous_runno        = "Zimmerman_AAC_2017",
    rab_caseum_runno         = "Zimmerman_AAC_2017"
  )) %>% 
  
  # JE moves this chunk up from the chunk below
  # parameters from BTZ043_Rabbit_LesionPK_Report_Jul2022_v2_JD.pdf
  rows_insert(., tibble(
    drug = "BTZ-043",    
    rab_KPL_lung             = 0.620,  
    rab_KPL_cell             = 10.8,
    rab_KPL_caseum           = 10, 
    rab_PC_lung              = 0.831, 
    rab_PC_cell              = 1.12, 
    rab_PC_caseum            = 0.149, 
    rab_lung_runno           = "Natasha/Annamarie",
    rab_cell_runno           = "Natasha/Annamarie",
    rab_caseum_runno         = "Natasha/Annamarie"
    )) %>% 
  
  # JE 2025 May 27 update BTZ 
  rows_upsert(., tibble(
    drug = "BTZ-043",
    rab_PC_caseum = 0.296
  )) %>% 
  
  # JE moves this chunk up from the chunk below, adds rate
  # /Dartois_collaboration/BDQ_rabbit_PK1/nm/
  rows_insert(., tibble(
    drug = "BDQ-M2",    
    rab_KPL_lung             = 0.108,  
    rab_KPL_cell             = 0.034, 
    rab_KPL_caseum           = 0.0053, 
    rab_PC_lung              = 1067, 
    rab_PC_cell              = 834, 
    rab_PC_caseum            = 31.2,
    rab_lung_runno           = "runL01e",
    rab_cell_runno           = "runL02b",
    rab_caseum_runno         = "runL06a"
    )) %>% 
  
  # add the run numbers for BDQ
  rows_upsert(., tibble(
    drug = "BDQ",    
    rab_lung_runno           = "runL01d",
    rab_cell_runno           = "runL02a",
    rab_caseum_runno         = "runL05b"
    )) %>% 
  
  # add the run numbers for DLM
  rows_upsert(., tibble(
    drug = "DLM",  
    rab_PC_lung              = 8.11,
    rab_PC_cell              = 9.18,
    rab_lung_runno           = "runL01b",
    rab_cell_runno           = "runL02g",
    rab_caseum_runno         = "runL03c",
    rab_caseous_runno        = "runL03"
    )) %>% 
  
  # JE add GSK-286
  rows_insert(., tibble(
    drug = "GSK-286",    
    rab_KPL_lung             = 0.39,  
    rab_KPL_cell             = 0.3, 
    rab_KPL_caseum           = 0.11, 
    rab_PC_lung              = 1.62, 
    rab_PC_cell              = 1.31, 
    rab_PC_caseum            = 1.99,
    rab_lung_runno           = "Annamarie",
    rab_cell_runno           = "Annamarie",
    rab_caseum_runno         = "Annamarie"
    )) %>% 
  
  # JE add mCLB-073
  rows_insert(., tibble(
    drug = "mCLB-073",    
    rab_KPL_lung             = 11.2,  
    rab_KPL_cell             = 2.05, 
    rab_KPL_caseum           = 0.19, 
    rab_PC_lung              = 1.86, 
    rab_PC_cell              = 1.55, 
    rab_PC_caseum            = 2.08,
    rab_lung_runno           = "Annamarie",
    rab_cell_runno           = "Annamarie",
    rab_caseum_runno         = "Annamarie"
    )) %>% 
  
  # JE updates TBAJ-587
  filter(drug != "TBAJ-587") %>% 
  rows_insert(., tibble(
    drug = "TBAJ-587",
    rab_KPL_lung             = 10.37,
    rab_KPL_cell             = 13.16,
    rab_KPL_caseum           = 0.01558,
    rab_PC_lung              = 89.76,
    rab_PC_cell              = 129.1,
    rab_PC_caseum            = 7.576,
    rab_lung_runno           = "L06",
    rab_cell_runno           = "L04b",
    rab_caseum_runno         = "L02b4"
  )) %>% 
  
  # JE adds TBAJ-587-M3
  rows_insert(., tibble(
    drug = "TBAJ-587-M3",
    rab_KPL_lung             = 10,
    rab_KPL_cell             = 10,
    rab_KPL_caseum           = 0.6451,
    rab_PC_lung              = 973,
    rab_PC_cell              = 1172,
    rab_PC_caseum            = 25.27,
    rab_lung_runno           = "L06b",
    rab_cell_runno           = "L04e",
    rab_caseum_runno         = "L07"
  )) %>% 
  
  # JE adds Annamarie's RBT model
  rows_insert(., tibble(
    drug = "RBT",
    rab_KPL_lung             = 0.154,
    rab_KPL_cell             = 0.209,
    rab_KPL_caseous          = 10,
    rab_KPL_caseum           = 10,
    rab_PC_lung              = 29,
    rab_PC_cell              = 47.3,
    rab_PC_caseous           = 51.6,
    rab_PC_caseum            = 8.94,
    rab_lung_runno           = "L01",
    rab_cell_runno           = "L02",
    rab_caseous_runno        = "L04",
    rab_caseum_runno         = "L03"
  )) %>% 
  
  # JE adds Annamarie's RZL model
  rows_insert(., tibble(
    drug = "RZL",
    rab_KPL_lung             = 10,
    rab_KPL_cell             = 10,
    rab_KPL_caseous          = 10,
    rab_KPL_caseum           = 10,
    rab_PC_lung              = 9.38,
    rab_PC_cell              = 23.1,
    rab_PC_caseous           = 14.4,
    rab_PC_caseum            = 4.99,
    rab_lung_runno           = "L22",
    rab_cell_runno           = "L23",
    rab_caseous_runno        = "L25",
    rab_caseum_runno         = "L24"
  )) %>% 
  
  # Jackie adds new RIF
  filter(drug != "RIF") %>% 
  rows_insert(., tibble(
    drug = "RIF",
    rab_KPL_lung          = 0.155,
    rab_KPL_cell          = 10,
    rab_KPL_caseum        = 0.036,
    rab_PC_lung           = 2.706,
    rab_PC_cell           = 2.907,
    rab_PC_caseum         = 3.897,
    rab_lung_runno        = "",
    rab_cell_runno        = "",
    rab_caseum_runno      = ""
  )) %>% 
  
  # Jackie adds new RPT
  filter(drug != "RPT") %>% 
  rows_insert(., tibble(
    drug = "RPT",
    rab_KPL_lung          = 0.53,
    rab_KPL_cell          = 0.82,
    rab_KPL_caseum        = 0.13,
    rab_PC_lung           = 1.33,
    rab_PC_cell           = 1.99,
    rab_PC_caseum         = 0.536,
    rab_lung_runno        = "",
    rab_cell_runno        = "",
    rab_caseum_runno      = ""
  )) %>% 
  
    # Jackie adds new TBAJ-876
  filter(drug != "TBAJ-876") %>% 
  rows_insert(., tibble(
    drug = "TBAJ-876",
    rab_KPL_lung          = 0.15,
    rab_KPL_cell          = 0.08,
    rab_KPL_caseum        = 0.03,
    rab_PC_lung           = 106.7,
    rab_PC_cell           = 145.8,
    rab_PC_caseum         = 4.82,
    rab_lung_runno        = "",
    rab_cell_runno        = "",
    rab_caseum_runno      = ""
  )) %>% 
  
    # Jackie adds new TBAJ-876-M3
  filter(drug != "TBAJ-876-M3") %>% 
  rows_insert(., tibble(
    drug = "TBAJ-876-M3",
    rab_KPL_lung          = 0.04,
    rab_KPL_cell          = 0.04,
    rab_KPL_caseum        = 0.002,
    rab_PC_lung           = 950.9,
    rab_PC_cell           = 867,
    rab_PC_caseum         = 55.47,
    rab_lung_runno        = "",
    rab_cell_runno        = "",
    rab_caseum_runno      = ""
  )) 


```

Format for drug partitioning fig
```{r}
rab_params_long <- lesion_pk_params_rab %>% 
  gather(key = "term_tag", value = "PC_rab", -drug) %>% 
  filter(grepl("PC",term_tag)) %>% 
  mutate(LESIONNAME = case_when(grepl("lung", term_tag) ~ "Normal lung",
                                grepl("cell", term_tag) ~ "Cellular Lesion",
                                grepl("cavity", term_tag) ~ "Cavity wall",
                                grepl("caseous", term_tag) ~ "Caseous Lesion",
                                grepl("caseum", term_tag) ~ "Caseum"))

hum_params_long <- lesion_pk_params_hum %>% 
  gather(key = "term_tag", value = "PC_hu", -drug) %>% 
  filter(grepl("PC",term_tag)) %>% 
  mutate(LESIONNAME = case_when(grepl("lung", term_tag) ~ "Normal lung",
                                grepl("cell", term_tag) ~ "Cellular Lesion",
                                grepl("cavity", term_tag) ~ "Cavity wall",
                                grepl("caseous", term_tag) ~ "Caseous Lesion",
                                grepl("caseum", term_tag) ~ "Caseum"))

parameters1 <- full_join(hum_params_long %>% select(-term_tag), 
                        rab_params_long %>% select(-term_tag)) %>%
                    mutate(PC_hu = as.numeric(PC_hu),
                           PC_rab = as.numeric(PC_rab)) %>%
                    # PC figures only need one version of INH 
                    filter(drug %notin% c("INH_s", "INH_f")) %>% 
                    mutate(drug = ifelse(drug=="INH_i", "INH", drug)) %>% 
                    mutate(log10PC_hu = log10(PC_hu),
                           log10PC_rab = log10(PC_rab)) %>% 
                    mutate(SET = ifelse(drug %in% drug_list, 0, 1)) %>% 
                    mutate(lesion = LESIONNAME) 
```

```{r}
# Migrated from methodpaper/code/drug_comparisons/220_correlation_20230221.R

setwd("~/Dropbox/Dartois_collaboration/methodpaper/code/drug_comparisons/")

parameters <- read.csv("correlation1_20220529.csv") %>% 
                    mutate(log10PC_hu = log10(PC_hu),
                           log10PC_rab = log10(PC_rab)) %>% 
                    mutate(drug = ifelse(drug=="MFX", "MXF", drug))

```

Effort to determine differences between two datasets
```{r}
parameters_examine <- parameters %>% 
  mutate(drug = ifelse(drug=="PTM", "PMD", drug)) %>%
  mutate(drug = ifelse(drug=="INH", "INH_i", drug)) %>% 
  select(drug, PC_hu, PC_rab, lesion) %>% 
  rename(LESIONNAME = lesion)  %>% 
  arrange(drug, LESIONNAME)

parameters1_examine <- parameters1 %>% 
  select(drug, PC_hu, PC_rab, LESIONNAME) %>% 
  arrange(drug, LESIONNAME)

setequal(parameters_examine,parameters1_examine)
setdiff(parameters_examine,parameters1_examine)

d <- parameters_examine %>% pull(drug) %>% unique()
d1 <- parameters1_examine %>% pull(drug) %>% unique()

unique(parameters_examine$drug)[parameters_examine %>% pull(drug) %>% unique() %notin% d1]
unique(parameters1_examine$drug)[parameters1_examine %>% pull(drug) %>% unique() %notin% d]

pe <- parameters_examine %>% 
  filter(drug%in%d1)

pe1 <- parameters1_examine %>% 
  filter(drug%in%d)

setequal(pe,pe1)
setdiff(pe,pe1)

examine <- full_join(parameters_examine, parameters1_examine, by = c("drug", "LESIONNAME"))

examine_zoom  <- examine %>% filter(PC_hu.x != PC_hu.y)
examine_zoom2 <- examine %>% filter(PC_rab.x != PC_rab.y)
```

# Figure 3C. Partitioning across all drugs

```{r fig.width=6.5, fig.height = 4}

# SET = 0 = Validation
# SET = 1 = Other
parms_val_set <- parameters1 %>% filter(SET==0)

parms_rab <- parameters1 %>% 
          mutate(PC_rab_caseum = ifelse(lesion=="Caseum", PC_rab, NA)) %>%
          arrange(drug) %>%
          group_by(drug) %>%
          fill(PC_rab_caseum, .direction = "downup") %>%
          ungroup() %>% 
          select(drug, lesion, PC_rab, PC_rab_caseum)

parms_rab$drug <- fct_reorder(parms_rab$drug, parms_rab$PC_rab_caseum, min)

parms_rab$lesion <- factor(parms_rab$lesion, levels = c("Caseum", 
                                                        "Caseous Lesion", 
                                                        "Cavity wall", 
                                                        "Cellular Lesion", 
                                                        "Normal lung"))

part_plt <- ggplot(parms_rab, mapping = aes(x = drug, y = PC_rab, shape = lesion, fill=lesion))+
  geom_point(size=1.8)+
  geom_point(parms_rab[parms_rab$lesion=="Caseum",], mapping = aes(x = drug, y = PC_rab),size=1.8)+
  ylab("Partition coefficient (rabbit)")+
  xlab("")+
  scale_shape_manual(values=c(21,22,23,24,25))+
  scale_fill_brewer(palette = "RdBu")+
  geom_hline(yintercept = 1, linetype="dashed", color="darkgrey")+
  theme_bw(base_size=10)+
  theme(axis.text=element_text(size=10),panel.grid.minor = element_blank(),
        axis.text.x=element_text(angle=45, hjust=1)
  )+
  # guides(fill="none")+
  scale_y_log10()+
  theme(panel.grid.major = element_blank(),
        legend.background = element_rect("transparent"),
        strip.background = element_rect("transparent"),
        legend.text = element_text(size=10),
        legend.justification = c(0, 1),
        legend.position = c(0.01, 1),
        legend.margin = margin(0,0,0,0.1),
        legend.direction = "vertical",
        legend.key.height = unit(0.005,'in'),
        legend.key.size = unit(0.1,'in'),
        legend.title = element_blank(),
        # legend.position = "none",
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

part_plt

# dimensions were previously 6.5x4 but moving to figure 3 as subsection so reducing dimension
pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_partitioning_v2.pdf", sep =""), width = 6.5, height = 3.7)

part_plt

dev.off()

```

```{r blinded-figure}

# parms_rab_blind <- parms_rab %>% 
#                         
#                         left_join(., data.frame(drug = parms_rab %>% arrange(PC_rab_caseum) %>%  pull(drug) %>% unique(),
#                                                 letter = paste0("Drug ", LETTERS[1:21]))) %>% 
#                                                 mutate(drug = letter)
# 
# p <- ggplot(parms_rab_blind, mapping = aes(x = drug, y = PC_rab, shape = lesion, fill = lesion))+
#   geom_point(size=2)+
#   geom_point(parms_rab_blind[parms_rab_blind$lesion=="Caseum",], mapping = aes(x = drug, y = PC_rab),size=2)+
#   ylab("Partition coefficient (rabbit)")+
#   xlab("")+
#   scale_shape_manual(values=c(21,22,23,24,25))+
#   scale_fill_brewer(palette = "RdBu")+
#   geom_hline(yintercept = 1, linetype="dashed", color="darkgrey")+
#   theme_classic(base_size=10)+
#   theme(axis.text=element_text(size=10),panel.grid.minor = element_blank(),
#         axis.text.x=element_text(angle=45, hjust=1)
#   )+
#   # guides(fill="none")+
#   scale_y_log10()+
#   theme(legend.background = element_rect("transparent"),
#       strip.background = element_rect("transparent"),
#       legend.text = element_text(size=10),
#       legend.justification = c(0, 1),
#       legend.position = c(0.01, 1),
#       legend.margin = margin(0,0,0,0.1),
#       legend.direction = "vertical",
#       legend.key.height = unit(0.005,'in'),
#       legend.key.size = unit(0.1,'in'),
#       legend.title = element_blank(),
#       # legend.position = "none",
#       panel.grid.minor = element_blank(),
#       panel.grid = element_blank(),
#       axis.title = element_text(size = 12),
#       axis.text = element_text(size = 12),
#       plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
# 
# p
# 
# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_partitioning_BLIND.pdf", sep =""), width = 6.5, height = 4)
# 
# p
# 
# dev.off()

```

# Figure 4. Rabbit-clinical correlation

## Add updated clinical PCs (20231109)

```{r}

parms_val_set_update <- left_join(parms_val_set, clinical_updated_PCs) %>% 
  mutate(Value = ifelse(is.na(Value), PC_hu, Value)) %>% 
  # rename so don't have to make changes to plotting code
  select(-PC_hu) %>% 
  rename(PC_hu = Value) %>% 
  mutate(log10PC_hu = log10(PC_hu))

```


# old versus new to understand how the relationship has changed with LCM observations from human added
```{r}

parm <- parameters %>%  # old
  select(drug, lesion, human_lesion_name, PC_hu, PC_rab) %>% 
  rename(PC_hu_old = PC_hu,
         PC_rab_old = PC_rab,
         LESIONNAME = lesion) %>% 
  left_join(., parms_val_set_update %>% # dataset that includes re-estimated parameters with human added
              select(drug, LESIONNAME, PC_hu, PC_rab)) %>% 
  filter(drug %in% drug_list) %>% # only take the validation set of drugs
  mutate(hu_diff = PC_hu_old - PC_hu,
         rab_diff = PC_rab_old - PC_rab)


parm %>% 
  ggplot(aes(PC_hu_old, PC_hu))+
  geom_point()+
  geom_abline(slope=1)+
  scale_y_log10()+
  scale_x_log10()

parm %>% 
  ggplot(aes(PC_rab_old, PC_rab))+
  geom_point()+
  geom_abline(slope=1)+
  scale_y_log10()+
  scale_x_log10()

# biggest diffs are in CFZ in humans
# RIF in rabbits with MGC analysis

```

```{r species-corr fig.width=6.5, fig.height=4}

# Migrated from methodpaper/code/drug_comparisons/220_correlation_20230221.R

setwd("~/Dropbox/Dartois_collaboration/methodpaper/code/drug_comparisons/")
#bunny_colors <- c("purple2","royalblue4", "#00aedb", "#d11141", "#00b159", "#f37735", "#ffc425")

DRUG_color_map = pal_jama("default")(10)
names(DRUG_color_map) <- drug_list

require(scales)

species_corr<- ggscatter(parms_val_set_update, x = "PC_rab", y = "PC_hu", 
          add = "reg.line", conf.int = T, 
          cor.coef = T, cor.method = "pearson", cor.coef.size = 3,
          label.x.npc = "right",
          label.y.npc = "bottom", point = F)+
  stat_regline_equation(vjust=0.5,size=3)+
  # geom_hline(yintercept = 1, linetype="dashed", color="darkgrey")+
  # geom_segment(x=0, xend=0, y=-1, yend=2, linetype="dashed", color="darkgrey")+
  geom_abline(slope=1, linetype = 2)+
  # geom_abline(slope = 1, intercept=0.5, linetype=2)+
  # geom_abline(slope = 1, intercept=-0.5, linetype=2)+
  geom_point(parms_val_set_update,mapping=aes(x=PC_rab, y= PC_hu,shape=lesion,fill=drug),color="black",size=1.5)+
  scale_shape_manual(values=c(21,22,23,24,25),name="")+
  scale_y_continuous(trans = log10_trans(),
                       breaks = trans_breaks("log10", function(x) ifelse(10^x %% 1 ==0, 10^x, NA )),
                       labels = trans_format("log10", math_format(10^.x)),
                       limits = c(NA, 10^2))+
  scale_x_continuous(trans = log10_trans(),
                   breaks = trans_breaks("log10", function(x) ifelse(10^x %% 1 ==0, 10^x, NA )),
                   labels = trans_format("log10", math_format(10^.x)))+
  scale_color_manual(name="", values=DRUG_color_map)+
  scale_fill_manual(name="", values=DRUG_color_map)+
  xlab("Rabbit Partition Coefficient")+
  ylab("Human Partition Coefficient")+
  # xlim(-0.75,3)+
  # ylim(-0.75,3)+
  ggtitle("Interspecies relationship")+
  guides(fill=guide_legend(override.aes=list(shape=21),size="none"))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text=element_text(size=10),
        legend.key.height = unit(0.11,'in'),
        legend.key.size = unit(0.1,'in'))+    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          strip.text.x = element_blank(),
          legend.text = element_text(size=10),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          #legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          # legend.margin = margin(0,0,0,0),
          # legend.direction = "vertical",
          # legend.key.height = unit(0.005,'in'),
          # legend.title = element_blank(),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 10),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 10,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 10,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.15), "cm"))
  

species_corr

pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_correlation.pdf", sep =""), width = 3, height = 3)

species_corr

dev.off()

```

# Figure SX. Leave one out analysis

```{r}
# Migrated from leave_one_drug_out_April2022_v2.R

lm_sum <- summary(lm(log10PC_hu ~ log10PC_rab, data = parms_val_set_update))
final_intercept <- lm_sum[["coefficients"]][1] # intercept
final_slope <- lm_sum[["coefficients"]][2] # slope
cortest <- cor.test(parms_val_set_update$log10PC_hu, parms_val_set_update$log10PC_rab, method = c("pearson"))
cortest[["estimate"]]
cortest[["p.value"]]

```

```{r}
#### remove one drug for loop 
drug_lst <- unique(parms_val_set_update$drug)

df <- data.frame()
lst <- list()

for ( i in 1:length(drug_lst)) {
  
  drug_selected <- drug_lst[i]
  
  print(drug_selected)
  
  remove_one_df <- parms_val_set_update[parms_val_set_update$drug!=drug_selected,]
  cortest <- cor.test(remove_one_df$log10PC_hu, remove_one_df$log10PC_rab, method = c("pearson"))
  lm_sum <- summary(lm(remove_one_df$log10PC_hu ~ remove_one_df$log10PC_rab))
  
  save <- data.frame(drug_missing = NA)
  save$drug_missing <- drug_selected
  save$intercept <- lm_sum[["coefficients"]][1]
  save$slope <- lm_sum[["coefficients"]][2]
  save$pearson.cor <- cortest[["estimate"]][['cor']]
  save$p.value <- cortest[["p.value"]]
  
  #assign(paste0("df_missing_",drug_list[i],sep=""),save)
  df <- rbind(df,save) # relationship when `drug.missing` is left out
  
  plt <- ggscatter(remove_one_df, x = "log10PC_rab", y = "log10PC_hu", 
            add = "reg.line", conf.int = TRUE, 
            cor.coef = F, cor.method = "pearson",   label.x.npc = "right",
            label.y.npc = "bottom", size =0.5)+
          stat_cor(size = 2)+
          stat_regline_equation(vjust=0.4, size=2)+
          geom_point(remove_one_df,mapping=aes(x= log10(PC_rab), y= log10(PC_hu),shape=lesion,fill=drug),size=2)+
          # geom_hline(yintercept = 1, linetype="dashed", color="darkgrey")+
          # geom_segment(x=0, xend=0, y=-1, yend=2, linetype="dashed", color="darkgrey")+
          # geom_abline(slope=1, linetype = 2)+
          #geom_abline(slope = 1, intercept=0.5, linetype=2)+
          #geom_abline(slope = 1, intercept=-0.5, linetype=2)+
          scale_shape_manual(values=c(21,22,23,24,25),name="")+
          # scale_y_continuous(trans = log10_trans(),
          #                      breaks = trans_breaks("log10", function(x) ifelse(10^x %% 1 ==0, 10^x, NA )),
          #                      labels = trans_format("log10", math_format(10^.x)),
          #                      limits = c(NA, 10^2))+
          # scale_x_continuous(trans = log10_trans(),
          #                  breaks = trans_breaks("log10", function(x) ifelse(10^x %% 1 ==0, 10^x, NA )),
          #                  labels = trans_format("log10", math_format(10^.x)))+
          scale_color_manual(name="", values=DRUG_color_map)+
          scale_fill_manual(name="", values=DRUG_color_map)+
          xlab("Rabbit Partition Coefficient")+
          ylab("Human Partition Coefficient")+
          xlim(-0.75,2.5)+
          ylim(-0.75,2.5)+
          ggtitle(paste0(drug_selected, " left out"))+
          guides(fill=guide_legend(override.aes=list(shape=21),size="none"))+
          theme_bw(base_size=6)+
          theme(panel.grid = element_blank(),
                axis.text=element_text(size=7),
                legend.key.height = unit(0.11,'in'),
                legend.key.size = unit(0.1,'in'),
                legend.position = "none")

  
  lst[[length(lst) + 1]] <- plt
}

grid.arrange(grobs = lst, nrow = 2)
## Map colors

pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_loocv.pdf", sep =""), width = 6.5, height = 4)

grid.arrange(grobs = lst, nrow = 2)

dev.off()

```

#### Predicted versus actual in human
```{r}

# calculate the predicted human PC for each drug of validation set, based on the relationship when that drug was left out
subset <- parms_val_set_update %>% 
  select(drug, lesion, log10PC_hu, log10PC_rab) %>% 
  left_join(., df, by = c("drug" = "drug_missing")) %>% # join with the parameters calculated in leave one out analysis
  mutate(calc_log10PC_hu = intercept + (slope * log10PC_rab)) %>% # use rabbit PC to predict human PC
  mutate(calc_PC_hu_sens = round(10**calc_log10PC_hu,3))  # calculate sensitivity analysis

# predictedPCs for all drugs moved to clinical lesion sim chunk

```

```{r test-set-results}

# p2 <- ggscatter(subset, x = "calc_log10PC_hu", y = "log10PC_hu",
#           add = "reg.line", conf.int = TRUE,
#           cor.coef = TRUE, cor.method = "pearson",   label.x.npc = "right",
#           label.y.npc = "bottom")+
#   geom_abline(slope=1)+
#   geom_abline(slope = 1, intercept=0.5, linetype=2)+
#   geom_abline(slope = 1, intercept=-0.5, linetype=2)+
#   stat_regline_equation(  vjust=0)+
#   # geom_point(g,mapping=aes(x=lnPC_rab, y= lnPC_hu,shape=lesion,fill=drug),size=4,alpha=0.2)+ #faded original points
#   geom_point(subset,mapping=aes(x=calc_log10PC_hu, y= log10PC_hu,shape=lesion,fill=drug),color="black",size=4)+
#   scale_shape_manual(values=c(21,22,23,24,25),name="")+
#   # scale_color_manual(name="", values=bunny_colors)+
#   # scale_fill_manual(name="", values=bunny_colors)+
#   scale_y_continuous(breaks = c(0,1,2),
#                      labels = math_format(10^.x))+
#   scale_x_continuous(breaks = c(0,1,2),
#                      labels = math_format(10^.x))+
#   scale_color_jama(name = "")+
#   scale_fill_jama(name = "")+
#   xlab("Predicted Partition Coefficient")+ # Corrected rabbit partition coefficient
#   ylab("Observed Partition Coefficient")+ # Human partition coefficent
#   # xlim(NA,1)+
#   # ylim(NA,1.5)+
#   ggtitle("Test set results of LOOCV")+
#   theme_bw()+
#   theme(panel.grid = element_blank(),
#         axis.text=element_text(size=10),
#         legend.key.height = unit(0.11,'in'),
#         legend.key.size = unit(0.1,'in'))+
#   guides(fill=guide_legend(override.aes=list(shape=21),size="none"))
# 
# p2

test_set_res <- ggplot()+
  geom_abline(slope=1, linetype = 1)+
  geom_abline(slope=1, intercept =  0.5, linetype = 2)+
  geom_abline(slope=1, intercept =  -0.5, linetype = 2)+
  # geom_abline(slope = 1, intercept=0.5, linetype=2)+
  # geom_abline(slope = 1, intercept=-0.5, linetype=2)+
  stat_regline_equation(  vjust=0)+
  # geom_point(g,mapping=aes(x=lnPC_rab, y= lnPC_hu,shape=lesion,fill=drug),size=4,alpha=0.2)+ #faded original points
  geom_point(subset,mapping=aes(x=calc_log10PC_hu, y= log10PC_hu,shape=lesion,fill=drug),color="black",size=1.5)+
  scale_shape_manual(values=c(21,22,23,24,25),name="")+
  scale_color_manual(name="", values=DRUG_color_map)+
  scale_fill_manual(name="", values=DRUG_color_map)+
  scale_y_continuous(breaks = c(0,1,2),
                     labels = math_format(10^.x),
                     limits = c(-1, 2))+
  scale_x_continuous(breaks = c(0,1,2),
                     labels = math_format(10^.x),
                     limits = c(-0.5, 1.5))+
  xlab("Predicted Partition Coefficient")+ # Corrected rabbit partition coefficient
  ylab("Observed Partition Coefficient")+ # Human partition coefficent
  # xlim(NA,1)+
  # ylim(NA,1.5)+
  ggtitle("Test set results of LOOCV")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text=element_text(size=10),
        legend.key.height = unit(0.11,'in'),
        legend.key.size = unit(0.1,'in'),
  # theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          strip.text.x = element_blank(),
  #         legend.text = element_text(size=6),
  #         #legend.position = c(0.8,0.1),
  #       legend.box = "horizontal",
  #       legend.spacing.y = unit(-0.2, "cm"),
  #       legend.spacing.x = unit(-0.2, "cm"),
  #       legend.justification = c(1, 0), legend.position = c(1, 0),
  #      legend.margin=margin(0,0,0,0),
  #       legend.box.margin=margin(0,0,0,0),
  #         # axis.title = element_text(size = 7),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 10,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 10,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))+
  
  guides(fill=guide_legend(override.aes=list(shape=21),size="none"))

test_set_res
``` 

```{r fig4-patchwork, fig.width=6.5}

fig4_top <- ggarrange(species_corr, test_set_res)#, common.legend = T, legend = "right")

fig4_top

```


#### remove one drug for loop IN CASEUM
```{r}
# 
# drug_list <- unique(g$drug)
# 
# df <- data.frame()
# 
# for ( i in 1:length(drug_list)) {
#   
#   remove_one_df <- g[g$drug!=drug_list[i] & g$lesion=="Caseum",]
#   cortest <- cor.test(remove_one_df$log10PC_hu, remove_one_df$log10PC_rab, method = c("pearson"))
#   lm_sum <- summary(lm(remove_one_df$log10PC_hu ~ remove_one_df$log10PC_rab))
#   
#   save <- data.frame(drug_missing = NA)
#   save$drug_missing <- drug_list[i]
#   save$intercept <- lm_sum[["coefficients"]][1]
#   save$slope <- lm_sum[["coefficients"]][2]
#   save$pearson.cor <- cortest[["estimate"]][['cor']]
#   save$p.value <- cortest[["p.value"]]
#   
#   #assign(paste0("df_missing_",drug_list[i],sep=""),save)
#   df <- rbind(df,save)
#   
#   ggscatter(remove_one_df, x = "log10PC_rab", y = "log10PC_hu", 
#             add = "reg.line", conf.int = TRUE, 
#             cor.coef = TRUE, cor.method = "pearson",   label.x.npc = "right",
#             label.y.npc = "bottom")+
#     geom_abline(slope=1)+
#     geom_abline(slope = 1, intercept=0.5, linetype=2)+
#     geom_abline(slope = 1, intercept=-0.5, linetype=2)+
#     stat_regline_equation(  vjust=3)+
#     geom_point(remove_one_df,mapping=aes(x=log10PC_rab, y= log10PC_hu,shape=lesion,fill=drug),color="black",size=4)+
#     scale_shape_manual(values=c(21,22,23,24,25),name="")+
#     scale_color_manual(name="", values=bunny_colors)+
#     scale_fill_manual(name="", values=bunny_colors)+
#     xlab("log10 (Rabbit partition coefficient)")+
#     ylab("log10 (Human partition coefficient)")+
#     xlim(-1.5,6)+
#     ylim(-1.5,4)+
#     ggtitle(paste0(drug_list[i], " removed"))+
#     theme_bw()+
#     guides(fill=guide_legend(override.aes=list(shape=21),size="none"))
#   
#   #ggsave(paste0("./figures/log10_",drug_list[i],"_",format(Sys.time(), "%Y%m%d_%X"),"_missing_in_caseum.pdf"), width = 7, height = 4)
#   
# }
```


# Figure 5. Clinical simulations

## Load Model Parameters
- Compile model parameters
- 1. Drug, dose, dosing frequency
- 2. Clinical plasma PK parameters with reference
- 3. Lesion parameters rate (K) and ratio (PC) from human, rabbit, or "corrected rabbit" with model reference

### 1. Drug, dose, dosing frequency
```{r}

# now all housed in excel with PK parameters (20240924)

# # Migrated from ~/Dartois_collaboration/method_paper/r_scripts/clinical_lesion_PK_simulations/all_drug_param_table.xlsx (20230609)
# 
# drug_dosing_info_tab <-  "drug dose_mg	II
#                           RIF	600	24
#                           RIF 1200 24
#                           RIF 1800 24
#                           INH_s	300	24
#                           INH_i	300	24
#                           INH_f	300	24
#                           PZA	1500	24
#                           MXF	400	24
#                           CFZ	100	24
#                           KAN	1000	24
#                           LZD	600	24
#                           BDQ	200	24
#                           BDQ 400 24
#                           TBAJ-587	25	24
#                           TBAJ-587	100	24
#                           TBAJ-587	400	24
#                           TBAJ-587-M3	25	24
#                           TBAJ-587-M3	100	24
#                           TBAJ-587-M3	400	24
#                           TBAJ-876	25	24
#                           TBAJ-876	50	24
#                           TBAJ-876	100	24
#                           TBAJ-876	200	24
#                           TBAJ-876-M3	25	24
#                           TBAJ-876-M3	50	24
#                           TBAJ-876-M3	100	24
#                           TBAJ-876-M3	200	24
#                           PMD	200	24
#                           DLM	100	12
#                           SZD	800	24
#                           SZD	1200	24
#                           SZD	1600	24
#                           SZD-M1	800	24
#                           SZD-M1	1200	24
#                           SZD-M1	1600	24
#                           TBI-223	1200	24
#                           TBI-223	2400	24
#                           OPC-167832	30	24
#                           OPC-167832	90	24
#                           GSK-656	1	24
#                           GSK-656	5	24
#                           GSK-656	10  24
#                           GSK-656	20	24
#                           RPT	1200	24"
# 
# drug_dosing_info <- read.table(text = drug_dosing_info_tab, header = TRUE) %>% 
#   
#   #JE adds EMB
#   rows_insert(., tibble(drug = "EMB",
#                         dose_mg = 1200,
#                         II = 24)) %>% 
#   #JE adds BTZ-043
#   rows_insert(., tibble(drug    = "BTZ-043",
#                         dose_mg = 1250,
#                         II      = 24)) %>% 
#   #JE adds BDQ-M2
#   rows_insert(., tibble(drug    = "BDQ-M2",
#                         dose_mg = c(200,400),
#                         II      = 24)) %>% 
#   #JE adds AMK
#   rows_insert(., tibble(drug    = "AMK",
#                         dose_mg = 1000,
#                         II      = 24)) %>% 
#   #JE adds RBT
#   rows_insert(., tibble(drug    = "RBT",
#                         dose_mg = 300,
#                         II      = 24)) %>% 
#   #JE adds mCLB-073
#   rows_insert(., tibble(drug    = "mCLB-073",
#                         dose_mg = c(50,100,200, 400),
#                         II      = 24))
#   
# # For metabolites, dose reflects dose of the parent
```


### 2. Clinical plasma PK parameters with reference
```{r}

clinical_pk_params <- read_excel(paste0(WD,"data/20241216_clinical_lesion_parameters_Anu_QC.xlsx")) %>% 
  mutate(across(-c("drug", "model_structure", "clinical_PK_ref", "QC done?", "Model status", "Notes"), as.numeric))

```

### 3b. Lesion parameters rate (K) and ratio (PC) of predicted/calculated human ("corrected rabbit")
Determine calculated PCs
```{r}

# predict PCs for each drug using the final relationship
predicted_PCs <- parameters1 %>% 
  mutate(Intercept = final_intercept,
         Slope = final_slope) %>% 
  mutate(calc_log10PC_hu = Intercept + (Slope * log10PC_rab)) %>% 
  mutate(calc_PC_hu = round(10**calc_log10PC_hu,3)) %>% 
  select(drug, lesion, PC_hu, calc_PC_hu)

# formatted to fit clinical_simulations_gates.R format
predicted_PCs_wide <- predicted_PCs %>% 
  select(drug, lesion, calc_PC_hu) %>%
  mutate(lesion = paste0("calc_PC_", tolower(sub(" ", "_", lesion)), sep="")) %>% 
  pivot_wider(names_from = lesion,
              values_from = calc_PC_hu)

#detour to have INH by metbolizer
INH_alone <- filter(predicted_PCs_wide, drug=="INH")
INH_by_metabolizer <- rbind(INH_alone, INH_alone, INH_alone)
INH_by_metabolizer$drug <- c("INH_s", "INH_f", "INH_i")

```

Use rabbit rates with the calculated PCs - is there a way we should think about scaling the rate from rabbit to human?
```{r}

rabbit_rates <- lesion_pk_params_rab %>% 
  select(drug, contains("rab_KPL")) %>% 
  unique()

colnames(rabbit_rates) <- paste0("calc_", substr(colnames(rabbit_rates), 5,20), sep="")
colnames(rabbit_rates)[1] <- "drug"

```
Combine the calculated rates and ratios
```{r}
# place back into final parameter table
lesion_pk_params_calc <- predicted_PCs_wide %>% 
  filter(drug!="INH") %>%
  rbind(INH_by_metabolizer) %>%
  left_join(., rabbit_rates)
```

### 4. Combine to a master parameter table
```{r}

# master parameter table

x <- clinical_pk_params %>% 
               left_join(., lesion_pk_params_hum, by = "drug") %>% 
               left_join(., lesion_pk_params_rab, by = "drug") %>% 
               left_join(., lesion_pk_params_calc, by = "drug") %>% 
               filter(!grepl("metab_depot_3_cmt_savic", model_structure)) %>% 
               filter(!grepl("metab_depot_3_cmt_2_transit", model_structure))

#write.csv( x, file = paste0( WD, "/data/", format(Sys.Date(), "%Y%m%d") , "_clinical_lesion_parameters.csv"), row.names = F)
#write.csv( lesion_parameters, file = paste0( WD, "/data/", format(Sys.Date(), "%Y%m%d") , "_clinical_lesion_parameters_object.csv"), row.names = F)
```

## Load simulated data

```{r}
# read the temp dataset parsed by michelle jin
setwd(paste0(WD,wd_r))
casMBC50_df <- read.csv("tmp_casMBC50_fromMJ.csv") %>% 
  rename(casMBC50_mgL = IC50_MG.L) %>% # I suspect this is not IC50 in mg/L, mutate below
              #mutate(DRUG = ifelse(DRUG == "INH", "INH_i",DRUG)) %>% 
              select(DRUG, casMBC50_mgL) %>% 
  mutate(DRUG = ifelse(DRUG == "PA824", "PMD",
                       ifelse(DRUG == "BDQ14", "BDQ",
                              ifelse(DRUG == "TBAJ587", "TBAJ-587",
                                     ifelse(DRUG == "TBAJ876", "TBAJ-876",
                                            ifelse(DRUG == "TBAJ876_M3", "TBAJ-876-M3",
                                                 ifelse(DRUG == "TBI223", "TBI-223",
                                                        ifelse(DRUG == "GSK656", "GSK-656",
                                                               ifelse(DRUG == "OPCC", "DLM",
                                                                      ifelse(DRUG == "OPC", "OPC-167832", DRUG)))))))))) %>% 
  # correct units:
  left_join(drug_potency %>% select(DRUG, MW)) %>% 
  rename(casMBC50_uM = casMBC50_mgL) %>% 
  mutate(casMBC50_mgL = casMBC50_uM * MW / 1000)

unique(casMBC50_df$DRUG)
```


```{r}
# Load simulations from clinical_simulations_gates.R (Dartois_collaboration/method_paper/r_scripts/clinical_lesion_PK_simulations)
# Load dfs: `simulation_collect_all_drugs` and `coverage_all_drugs`
load("20241216_simulated_data.RData")
load("caseumMBC50.RData") #nls

# add GTX, that was done post hoc
df_gtx_sim_output <- read_csv(paste0(WD, "data/clinical_pop_PK_models/GTX/df_gtx_sim_output.csv")) 

df_gtx_conc <- df_gtx_sim_output %>% 
  rename(TIME = t) %>% 
  mutate(CPLASMA = CP) %>% 
  mutate(ID = 1, DOSE = 400) %>% 
  select(ID, DOSE, TIME, TAD, CP, CPLASMA, CLUNG, CCELL, CCAS) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "TAD", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("CPLASMA", CPname) ~ "Plasma",
                                grepl("CLUNG", CPname) ~ "Lung",
                                grepl("CCELL", CPname) ~ "Cellular lesion",
                                grepl("CCAS", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "GTX",
         DRUG_name_long = "Gatifloxacin",
         FLAG = 1,
         II = "QD") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")


### add the BDQ, TBAJs simulations that were done in ####
df_bdq_sim_output     <- read_nm_table(paste0(WD, "data/clinical_pop_PK_models/BDQ/sdtab662")) # two doses (200 and 400 mg)
df_tbaj587_sim_output <- read_nm_table(paste0(WD, "data/clinical_pop_PK_models/TBAJ-587/sdtab6")) # 
df_tbaj876_sim_output <- read_nm_table(paste0(WD, "data/clinical_pop_PK_models/TBAJ-876/sdtab0546")) # 

# format
df_bdq_conc <- df_bdq_sim_output %>% 
  filter(FLAG==1) %>% 
  filter(EVID==0) %>% 
  mutate(CP = CPplasma) %>% 
  select(ID, DOSE, TIME, starts_with("CP")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("plasma", CPname) ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "BDQ",
         DRUG_name_long = "Bedaquiline",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")

df_tbaj587_conc <- df_tbaj587_sim_output %>% 
  filter(METAB==1) %>% 
  filter(EVID==0) %>% 
  mutate(DOSE = round(DOSE * 614.5, digits = 0)) %>% # mmol to mg = DOSE (mmol) * MW (mg/mmol) 
  mutate(CP = CPplasma) %>% 
  select(ID, DOSE, TIME, starts_with("CP")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("plasma", CPname) ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "TBAJ-587",
         DRUG_name_long = "TBAJ-587",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")

df_tbaj876_conc <- df_tbaj876_sim_output %>% 
  filter(METAB==1) %>% 
  filter(EVID==0) %>% 
  mutate(CP = Cparent) %>% 
  select(ID, DOSE, TIME, CP, starts_with("Cp")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(CPname == "Cparent" ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "TBAJ-876",
         DRUG_name_long = "TBAJ-876",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")

# format metabolite
df_bdqm2_conc <- df_bdq_sim_output %>% 
  filter(FLAG==2) %>% 
  filter(EVID==0) %>% 
  mutate(CP = CM2plasma) %>% 
  select(ID, DOSE, TIME, CP, starts_with("CM2")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("plasma", CPname) ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "BDQ-M2",
         DRUG_name_long = "Bedaquiline-M2",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")

df_tbaj587m3_conc <- df_tbaj587_sim_output %>% 
  filter(METAB==2) %>% 
  filter(EVID==0) %>% 
  mutate(DOSE = round(DOSE * 614.5, digits = 0)) %>% # mmol to mg = DOSE (mmol) * MW (mg/mmol) 
  mutate(CP = CM3plasma) %>% 
  select(ID, DOSE, TIME, CP, starts_with("CM3")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("plasma", CPname) ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "TBAJ-587-M3",
         DRUG_name_long = "TBAJ-587-M3",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")

df_tbaj876m3_conc <- df_tbaj876_sim_output %>% 
  filter(METAB==2) %>% 
  filter(EVID==0) %>% 
  mutate(CP = Cmetab) %>% 
  select(ID, DOSE, TIME, CP, starts_with("Cmeta")) %>% 
  pivot_longer(cols = -c("ID", "DOSE", "TIME", "CP"), names_to = "CPname", values_to = "CLESION") %>% 
  mutate(LESIONNAME = case_when(grepl("plasma", CPname) ~ "Plasma",
                                grepl("lung", CPname) ~ "Lung",
                                grepl("cell", CPname) ~ "Cellular lesion",
                                grepl("caseum", CPname) ~ "Caseum")) %>% 
  mutate(SPECIES = "Corrected \nRabbit",
         DRUG = "TBAJ-876-M3",
         DRUG_name_long = "TBAJ-876-M3",
         FLAG = 1,
         II = "24") %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", II, sep = "_")) %>% 
  filter(between(TIME, max(TIME)-24, max(TIME))) %>% 
  mutate(TAD = TIME-(max(TIME)-24)) %>% 
  select("ROW_ID", "DRUG", "DOSE", "II", "SPECIES", "LESIONNAME", "TIME", "CP", "CLESION", "TAD", "FLAG")


# matches analysis in RShiny
sim_df <- simulation_collect_all_drugs %>% 
  # remove darqs performed using PKPDsim
  filter(!grepl("BDQ", DRUG)) %>% 
  filter(!grepl("TBAJ", DRUG)) %>% 
  
  # add darqs simulatted in NONMEM
  bind_rows(., df_bdq_conc) %>% 
  bind_rows(., df_tbaj587_conc) %>% 
  bind_rows(., df_tbaj876_conc) %>% 
  
  bind_rows(., df_bdqm2_conc) %>% 
  bind_rows(., df_tbaj587m3_conc) %>% 
  bind_rows(., df_tbaj876m3_conc) %>% 
  
  #add GTX from data/clinical_pop_PK_models/GTX/GTX_pkpdsim.R
  bind_rows(., df_gtx_conc) %>% 
  
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH",DRUG )) %>% 
  
  ## if in the 7 validation drug list, then use Human lesion parameters ##
  mutate(FLAG = ifelse(DRUG %in% drug_list & SPECIES == "Human", 1,
                       ifelse(DRUG %notin% drug_list & SPECIES == "Corrected \nRabbit", 1, 0))) %>% 
  filter(FLAG == 1) %>% 
  ##
  
  
  mutate(SPECIES = ifelse(SPECIES == "Corrected \nRabbit", "Corrected Rabbit", SPECIES)) %>% 
  # filter(SPECIES != "Human") %>% 
  # filter(SPECIES != "Rabbit") %>% 
  filter(LESIONNAME %in% c("Plasma", "Lung", "Cellular lesion", "Caseum"))

target_labels <- drug_potency_MRT2 %>% 
  select( DRUG, DRUG_name_long, LESIONNAME, MW, contains("mgL")) %>% 
  pivot_longer(cols = contains("mgL"), names_to = "LABEL", values_to = "TARGET")

sim_df <- sim_df %>% 
  left_join(., target_labels) %>% 
  mutate(LESIONNAME = factor(LESIONNAME, levels = lesion_level))

coverage_all_drugs_intermediate <- sim_df %>%
  mutate(II_num = ifelse(II == "BID", 12, 24)) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  #filter(SPECIES %in% c("Corrected Rabbit")) %>% 
  filter(LABEL %in% c("MRT_mgL")) %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) 

coverage_all_drugs <- coverage_all_drugs_intermediate %>% 
  filter(coverage_above_MRT == 1) %>% 
  mutate(LESIONNAME = factor(LESIONNAME, levels = lesion_level)) %>% 
  group_by(DRUG, DOSE) 

```

### Plots

#### Coverage above MRT (one color)
```{r fig.height=2}

MRT_TOTAL_df <- sim_df %>%
                  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
                  #filter(SPECIES %in% c("Corrected Rabbit")) %>% 
                  filter(LABEL %in% c("MRT_mgL")) %>% 
                  filter(LESIONNAME == "Caseum") %>% 
                  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
                  group_by(ROW_ID) %>% 
                  summarise(MRT_TOTAL = sum(coverage_above_MRT)) %>%
                  mutate(MRT_TOTAL = ifelse(is.na(MRT_TOTAL), 0, MRT_TOTAL))

blanks <- cross_join(coverage_all_drugs %>% select(ROW_ID) %>% unique(),
                     expand_grid(TAD = seq(0,24),
                                 LESIONNAME = factor(c("Plasma", "Lung", "Cellular lesion", "Caseum"),
                                                     levels = lesion_level))) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " "))

coverage_all_drugs %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  left_join(., MRT_TOTAL_df) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH", DRUG)) %>% 
 # mutate(ROW_ID = with(MRT_TOTAL, reorder(ROW_ID))) %>% 
  mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
                                       LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
                                       LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
                                       LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC50")) %>%
  mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
                                                                  "Lung PK\nover MacIC90",
                                                                  "Cellular lesion PK\nover MacIC90",
                                                                  "Caseum PK\nover casMBC50"))) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  ungroup() %>% 
  arrange(desc(DRUG), desc(DOSE)) %>% 
  mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) %>% 
  ggplot(mapping = aes(x = TAD+0.5, y = ROW_ID, fill= factor(coverage_above_MRT)))+
  geom_point(blanks %>% 
               ungroup() %>% 
               arrange(desc(DRUG), desc(DOSE)) %>% 
               mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) , 
             mapping = aes(x = TAD+0.5, y = ROW_ID), 
             color="black", shape = 22, size = 1.8, stroke = 0.2, inherit.aes = F)+
  geom_point(shape = 22, size = 1.8, stroke = 0.2)+
  theme_classic(base_size = 10)+
  scale_x_continuous(breaks = seq(0, 24,4), labels = seq(0,24,4), limits = c(0,24))+
  facet_wrap(~LESIONNAME_header, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("steelblue4", "black"))+
  theme(legend.background = element_rect("transparent"),
      strip.background = element_rect("transparent"),
      legend.text = element_text(size=5),
      #legend.justification = c(1, 1),
      #legend.position = c(1, 1),
      legend.margin = margin(0,0,0,0.1),
      legend.direction = "vertical",
      legend.key.height = unit(0.005,'in'),
      legend.key.size = unit(0.1,'in'),
      legend.position = "none",
      panel.grid.minor = element_blank(),
      panel.grid = element_blank(),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 7),
      # axis.title = element_blank(),
      strip.text = element_text(size = 8,
                                margin = margin(0.1,0,0.05,0, "cm")),
      plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

ggsave(plot = last_plot(),
       paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_plot_all.pdf"),
       width = 6.5,
       height = 6,
       units = c("in"))

### NO METAB
blanks <- cross_join(coverage_all_drugs %>% select(ROW_ID) %>% unique(),
                     expand_grid(TAD = seq(0,24),
                                 LESIONNAME = factor(c("Plasma", "Lung", "Cellular lesion", "Caseum"),
                                                     levels = lesion_level))) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  filter(DRUG %notin% c("TBAJ-587-M3", "TBAJ-876-M3", "BDQ-M2", "SZD-M1"))

coverage_all_drugs %>% 
  filter(DRUG %notin% c("TBAJ-587-M3", "TBAJ-876-M3", "BDQ-M2", "SZD-M1")) %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  left_join(., MRT_TOTAL_df) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH", DRUG)) %>% 
 # mutate(ROW_ID = with(MRT_TOTAL, reorder(ROW_ID))) %>% 
  mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
                                       LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
                                       LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
                                       LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC50")) %>%
  mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
                                                                  "Lung PK\nover MacIC90",
                                                                  "Cellular lesion PK\nover MacIC90",
                                                                  "Caseum PK\nover casMBC50"))) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  ungroup() %>% 
  arrange(desc(DRUG), desc(DOSE)) %>% 
  mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) %>% 
  ggplot(mapping = aes(x = TAD+0.5, y = ROW_ID, fill= factor(coverage_above_MRT)))+
  geom_point(blanks %>% ungroup() %>% 
               arrange(desc(DRUG), desc(DOSE)) %>%
               mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) ,
             mapping = aes(x = TAD+0.5, y = ROW_ID),
             color="black", shape = 22, size = 1.8, stroke = 0.2, inherit.aes = F)+
  geom_point(shape = 22, size = 1.8, stroke = 0.2)+
  theme_classic(base_size = 10)+
  scale_x_continuous(breaks = seq(0, 24,4), labels = seq(0,24,4), limits = c(0,24))+
  facet_wrap(~LESIONNAME_header, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("steelblue4", "black"))+
  theme(legend.background = element_rect("transparent"),
      strip.background = element_rect("transparent"),
      legend.text = element_text(size=5),
      #legend.justification = c(1, 1),
      #legend.position = c(1, 1),
      legend.margin = margin(0,0,0,0.1),
      legend.direction = "vertical",
      legend.key.height = unit(0.005,'in'),
      legend.key.size = unit(0.1,'in'),
      legend.position = "none",
      panel.grid.minor = element_blank(),
      panel.grid = element_blank(),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 7),
      # axis.title = element_blank(),
      strip.text = element_text(size = 8,
                                margin = margin(0.1,0,0.05,0, "cm")),
      plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

ggsave(plot = last_plot(),
       paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_plot_all_NO_METAB.pdf"),
       width = 6.5,
       height = 5,
       units = c("in"))

## ONLY METAB
blanks <- cross_join(coverage_all_drugs %>% select(ROW_ID) %>% unique(),
                     expand_grid(TAD = seq(0,24),
                                 LESIONNAME = factor(c("Plasma", "Lung", "Cellular lesion", "Caseum"),
                                                     levels = lesion_level))) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  filter(DRUG %in% c("TBAJ-587-M3", "TBAJ-876-M3", "BDQ-M2", "SZD-M1"))

coverage_all_drugs %>% 
  filter(DRUG %in% c("TBAJ-587-M3", "TBAJ-876-M3", "BDQ-M2", "SZD-M1")) %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  left_join(., MRT_TOTAL_df) %>% 
  mutate(DRUG = case_when(DRUG == "OPC-167832" ~ "QBD",
                          DRUG == "GSK-656" ~ "GFB",
                          DRUG == "mCLB-073" ~ "TBD-11",
                           .default = DRUG)) %>% 
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH", DRUG)) %>% 
 # mutate(ROW_ID = with(MRT_TOTAL, reorder(ROW_ID))) %>% 
  mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
                                       LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
                                       LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
                                       LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC50")) %>%
  mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
                                                                  "Lung PK\nover MacIC90",
                                                                  "Cellular lesion PK\nover MacIC90",
                                                                  "Caseum PK\nover casMBC50"))) %>% 
  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
  ungroup() %>% 
  arrange(desc(DRUG), desc(DOSE)) %>% 
  mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) %>% 
  ggplot(mapping = aes(x = TAD+0.5, y = ROW_ID, fill= factor(coverage_above_MRT)))+
  geom_point(blanks %>% ungroup() %>% 
               arrange(desc(DRUG), desc(DOSE)) %>%
               mutate(ROW_ID = factor(ROW_ID, unique(ROW_ID))) ,
             mapping = aes(x = TAD+0.5, y = ROW_ID),
             color="black", shape = 22, size = 1.8, stroke = 0.2, inherit.aes = F)+
  geom_point(shape = 22, size = 1.8, stroke = 0.2)+
  theme_classic(base_size = 10)+
  scale_x_continuous(breaks = seq(0, 24,4), labels = seq(0,24,4), limits = c(0,24))+
  facet_wrap(~LESIONNAME_header, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("steelblue4", "black"))+
  theme(legend.background = element_rect("transparent"),
      strip.background = element_rect("transparent"),
      legend.text = element_text(size=5),
      #legend.justification = c(1, 1),
      #legend.position = c(1, 1),
      legend.margin = margin(0,0,0,0.1),
      legend.direction = "vertical",
      legend.key.height = unit(0.005,'in'),
      legend.key.size = unit(0.1,'in'),
      legend.position = "none",
      panel.grid.minor = element_blank(),
      panel.grid = element_blank(),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 7),
      # axis.title = element_blank(),
      strip.text = element_text(size = 8,
                                margin = margin(0.1,0,0.05,0, "cm")),
      plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

ggsave(plot = last_plot(),
       paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_plot_all_ONLY_METAB.pdf"),
       width = 6.5,
       height = 3,
       units = c("in"))

```

#### Coverage for Rada's presentation
```{r fig.height=2}

MRT_TOTAL_df <- sim_df %>%
                  mutate(ROW_ID = paste(DRUG, DOSE, "mg", sep = " ")) %>% 
                  filter(SPECIES %in% c("Corrected Rabbit")) %>% 
                  filter(LABEL %in% c("MRT_mgL")) %>% 
                  filter(LESIONNAME == "Caseum") %>% 
                  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
                  group_by(ROW_ID) %>% 
                  summarise(MRT_TOTAL = sum(coverage_above_MRT)) %>%
                  mutate(MRT_TOTAL = ifelse(is.na(MRT_TOTAL), 0, MRT_TOTAL))

blanks <- cross_join(coverage_all_drugs %>% ungroup() %>% 
                       filter(DRUG %notin% c("SZD-M1", "TBAJ-587-M3", "AMK", "BDQ-M2")) %>% 
                       select(ROW_ID) %>% unique(),
                     expand_grid(TAD = seq(0,24),
                                 LESIONNAME = factor(c("Plasma", "Lung", "Cellular lesion", "Caseum"),
                                                     levels = lesion_level)))

coverage_all_drugs %>% 
  filter(DRUG %notin% c("SZD-M1", "TBAJ-587-M3", "AMK", "BDQ-M2")) %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  left_join(., MRT_TOTAL_df) %>% 
  ungroup() %>%
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH", DRUG)) %>% 
  arrange(-MRT_TOTAL) %>% 
  mutate(ROW_ID = fct_reorder(as.factor(ROW_ID), MRT_TOTAL)) %>%
  mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
                                       LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
                                       LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
                                       LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC50")) %>%
  mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
                                                                  "Lung PK\nover MacIC90",
                                                                  "Cellular lesion PK\nover MacIC90",
                                                                  "Caseum PK\nover casMBC50"))) %>% 
  ggplot(mapping = aes(x = TAD+0.5, y = ROW_ID, fill= factor(coverage_above_MRT)))+
  geom_point(blanks, mapping = aes(x = TAD+0.5, y = ROW_ID), 
             color="black", shape = 22, size = 1.8, stroke = 0.2, inherit.aes = F)+
  geom_point(shape = 22, size = 1.8, stroke = 0.2)+
  theme_classic(base_size = 10)+
  scale_x_continuous(breaks = seq(0, 24,4), labels = seq(0,24,4), limits = c(0,24))+
  facet_wrap(~LESIONNAME_header, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("steelblue4", "black"))+
  theme(legend.background = element_rect("transparent"),
      strip.background = element_rect("transparent"),
      legend.text = element_text(size=5),
      #legend.justification = c(1, 1),
      #legend.position = c(1, 1),
      legend.margin = margin(0,0,0,0.1),
      legend.direction = "vertical",
      legend.key.height = unit(0.005,'in'),
      legend.key.size = unit(0.1,'in'),
      legend.position = "none",
      panel.grid.minor = element_blank(),
      panel.grid = element_blank(),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 7),
      # axis.title = element_blank(),
      strip.text = element_text(size = 8,
                                margin = margin(0.1,0,0.05,0, "cm")),
      plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))

# ggsave(plot = last_plot(),
#        paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_plot_all_forRada_20231204_presentation.pdf"),
#        width = 6.5,
#        height = 4.6,
#        units = c("in"))

```

## PK over time with in vitro targets as dashed lines
```{r}

sim_df %>% 
  filter(DRUG == "CFZ") %>% 
  filter(LABEL %in% c("MRT_mgL")) %>% 
  ggplot(aes(x = TAD, y = CLESION, group = interaction(DOSE,SPECIES)))+
  facet_grid(DRUG~LESIONNAME)+
  geom_line()+
  geom_hline(aes(yintercept = TARGET), linetype = "dashed")+
  theme_bw(base_size = 7)+
  scale_y_log10()+
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(size = 3))

ggsave(plot = last_plot(),
       paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_PK_plot_all.pdf"),
       width = 12,
       height = 16,
       units = c("in"))

sim_df %>% 
  filter(LABEL %in% c("MRT_mgL")) %>% 
  ggplot(aes(x = TAD, y = CLESION, group = factor(DOSE)))+
  facet_wrap(DRUG~LESIONNAME, ncol=4, scales = "free_y", strip.position="right")+
  geom_line()+
  geom_hline(aes(yintercept = TARGET), linetype = "dashed")+
  theme_bw(base_size = 7)+
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(size = 3))

ggsave(plot = last_plot(),
       paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_PK_plot_all-w-targets.pdf"),
       width = 12,
       height = 16,
       units = c("in"))

```


#### Coverage above MRT (two colors)
```{r fig.height=2}
# SELECT REGIMENS rabbit lesion parameters only and remove Cavity wall and Caseous lesion

# select_regimens <- c("RIF_600_mg_24",
#                      "INH_i_300_mg_24",
#                      "PZA_1500_mg_24",
#                      "MXF_400_mg_24",       
#                      "CFZ_100_mg_24",       
#                      "KAN_1000_mg_24",     
#                      "LZD_600_mg_24",
#                      "BDQ_200_mg_24",       
#                      "TBAJ-587_400_mg_24",  
#                      "PMD_200_mg_24",       
#                      "DLM_100_mg_12",       
#                      "SUT_1200_mg_24",      
#                      "TBI-223_1800_mg_24",  
#                      "OPC-167832_30_mg_24", 
#                      "GSK-656_20_mg_24",    
#                      "RPT_1200_mg_24")
# 
# # Rabbit
# p <- coverage_all_drugs %>% 
#   filter(ROW_ID %in% select_regimens) %>% 
#   filter(SPECIES=="Rabbit") %>% 
#   filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
#   left_join(., coverage_all_drugs %>% 
#               filter(ROW_ID %in% select_regimens) %>% 
#               filter(SPECIES == "Rabbit") %>% 
#               filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
#               group_by(DRUG) %>% 
#               summarise(MRT_TOTAL = sum(coverage_above_MRT))) %>% 
#   mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
#   mutate(DRUG = fct_reorder(DRUG, MRT_TOTAL, min)) %>% 
#   mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
#                                        LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
#                                        LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
#                                        LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC90")) %>%
#   mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
#                                                                   "Lung PK\nover MacIC90",
#                                                                   "Cellular lesion PK\nover MacIC90",
#                                                                   "Caseum PK\nover casMBC90"))) %>% 
#   # make color based on validation drug or new drug
#   mutate(coverage_above_MRT1 = case_when(coverage_above_MRT == 1 & DRUG %notin% drug_list ~ 2, # priority drugs
#                                          coverage_above_MRT == 1 & DRUG %in% drug_list ~ 1, # validation
#                                          coverage_above_MRT == 0 ~ 0)) %>% #blank 
#   ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT1)))+
#   geom_point(shape = 22, size = 1.8, stroke = 0.2)+
#   theme_classic(base_size = 10)+
#   scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
#   facet_wrap(~LESIONNAME_header, nrow=1)+
#   labs(y = "",
#        x = "Time after dose (hours)")+
#   scale_fill_manual(values=c("white","steelblue4", "steelblue3"), name="",
#                     labels=c("below target","above target"))+
#   theme(legend.background = element_rect("transparent"),
#       strip.background = element_rect("transparent"),
#       legend.text = element_text(size=5),
#       #legend.justification = c(1, 1),
#       #legend.position = c(1, 1),
#       legend.margin = margin(0,0,0,0.1),
#       legend.direction = "vertical",
#       legend.key.height = unit(0.005,'in'),
#       legend.key.size = unit(0.1,'in'),
#       legend.position = "none",
#       panel.grid.minor = element_blank(),
#       panel.grid = element_blank(),
#       axis.title = element_text(size = 7),
#       axis.text = element_text(size = 5),
#       # axis.title = element_blank(),
#       strip.text = element_text(size = 5,
#                                 margin = margin(0.1,0,0.05,0, "cm")),
#       plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
# 
# # Corrected Rabbit / Predicted human
# p1 <- coverage_all_drugs %>% 
#   filter(ROW_ID %in% select_regimens) %>% 
#   filter(SPECIES=="Corrected \nRabbit") %>% 
#   filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
#   left_join(., coverage_all_drugs %>% 
#               filter(ROW_ID %in% select_regimens) %>% 
#               filter(SPECIES == "Corrected \nRabbit") %>% 
#               filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
#               group_by(DRUG) %>% 
#               summarise(MRT_TOTAL = sum(coverage_above_MRT))) %>% 
#   mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
#                                        LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
#                                        LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
#                                        LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC90")) %>%
#   mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
#                                                                   "Lung PK\nover MacIC90",
#                                                                   "Cellular lesion PK\nover MacIC90",
#                                                                   "Caseum PK\nover casMBC90"))) %>% 
#   mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
#   mutate(DRUG = fct_reorder(DRUG, MRT_TOTAL, min)) %>% 
#   
#   # make color based on validation drug or new drug
#   mutate(coverage_above_MRT1 = case_when(coverage_above_MRT == 1 & DRUG %notin% drug_list ~ 2, # priority drugs
#                                          coverage_above_MRT == 1 & DRUG %in% drug_list ~ 1, # validation
#                                          coverage_above_MRT == 0 ~ 0)) %>% #blank 
#   ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT1)))+
#   geom_point(shape = 22, size = 1.8, stroke = 0.2)+
#   theme_classic(base_size=10)+
#   scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
#   facet_wrap(~LESIONNAME_header, nrow=1)+
#   labs(y = "",
#        x = "Time after dose (hours)")+
#   scale_fill_manual(values=c("white","steelblue4", "steelblue3"), name="",
#                     labels=c("below target","above target"))+
#   theme(legend.background = element_rect("transparent"),
#     strip.background = element_rect("transparent"),
#     legend.text = element_text(size=5),
#     #legend.justification = c(1, 1),
#     #legend.position = c(1, 1),
#     legend.margin = margin(0,0,0,0.1),
#     legend.direction = "vertical",
#     legend.key.height = unit(0.005,'in'),
#     legend.key.size = unit(0.1,'in'),
#     legend.position = "none",
#     panel.grid.minor = element_blank(),
#     panel.grid = element_blank(),
#     axis.title = element_text(size = 7),
#     axis.text = element_text(size = 5),
#     # axis.title = element_blank(),
#     strip.text = element_text(size = 5,
#                               margin = margin(0.1,0,0.05,0, "cm")),
#     plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
# 
# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_sim_RABBIT_params_2co.pdf", sep =""), width = 6.5, height = 8/4)
# 
# p
# 
# dev.off()
# 
# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_sim_CORRECTEDRABBIT_params_2co.pdf", sep =""), width = 6.5, height = 8/4)
# 
# p1
# 
# dev.off()
# 
# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_sim_compare_2co.pdf", sep =""), width = 6.5, height = 8/2)
# 
# grid.arrange(grobs = list(p,p1), nrow=2)
# dev.off()

```

#### Dose-ranging for new drugs - Corrected Rabbit
```{r fig.height=2}
# DRUG-specific; Caseum only

d_r_drugs <- c("TBAJ-587","GSK-656","SZD") #drugs with dose-ranging sims

coverage_plot <- lapply(d_r_drugs, function(the_drug){
  
coverage_all_drugs %>% 
  filter(DRUG == the_drug) %>% 
  filter(SPECIES=="Corrected \nRabbit") %>% 
  filter(LESIONNAME %in% c("Caseum")) %>% 
  left_join(., coverage_all_drugs %>% 
              filter(DRUG == the_drug) %>% 
              filter(SPECIES == "Corrected \nRabbit") %>% 
              filter(LESIONNAME %notin% c("Caseum")) %>% 
              group_by(DRUG) %>% 
              summarise(MRT_TOTAL = sum(coverage_above_MRT))) %>% 
  mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
  mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
                                       LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
                                       LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
                                       LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC90")) %>%
  mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
                                                                  "Lung PK\nover MacIC90",
                                                                  "Cellular lesion PK\nover MacIC90",
                                                                  "Caseum PK\nover casMBC90"))) %>% 
  mutate(DOSE_mg = paste0(DOSE, " mg")) %>% 
  mutate(DOSE_mg = fct_reorder(DOSE_mg, DOSE, min)) %>% 
  ggplot(mapping = aes(x = TAD, y = DOSE_mg, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 1.8, stroke = 0.2)+
  theme_classic(base_size = 10)+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~DRUG, nrow=1)+
  labs(y = "",
       x = "")+
  scale_fill_manual(values=c("white","steelblue4"), name="",
                    labels=c("below target","above target"))+
  theme(legend.background = element_rect("transparent"),
      strip.background = element_rect("transparent"),
      legend.text = element_text(size=5),
      #legend.justification = c(1, 1),
      #legend.position = c(1, 1),
      legend.margin = margin(0,0,0,0.1),
      legend.direction = "vertical",
      legend.key.height = unit(0.005,'in'),
      legend.key.size = unit(0.1,'in'),
      legend.position = "none",
      panel.grid.minor = element_blank(),
      panel.grid = element_blank(),
      axis.title = element_text(size = 7),
      axis.text = element_text(size = 5),
      # axis.title = element_blank(),
      strip.text = element_text(size = 5,
                                margin = margin(0.1,0,0.05,0, "cm")),
      plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
  
  
})

# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_sim_CORRECTEDRABBIT_params_D-R_cas_only.pdf", sep =""), width = 6.5, height = 1)
# 
# grid.arrange(grobs = coverage_plot, nrow=1)
# 
# dev.off()



```


#### Dose-ranging for new drugs - Rabbit
```{r fig.height=2}
# DRUG-specific; Caseum only

# d_r_drugs <- c("TBAJ-587","GSK-656","SUT") #drugs with dose-ranging sims
# 
# coverage_plot <- lapply(d_r_drugs, function(the_drug){
#   
# coverage_all_drugs %>% 
#   filter(DRUG == the_drug) %>% 
#   filter(SPECIES=="Rabbit") %>% 
#   filter(LESIONNAME %in% c("Caseum")) %>% 
#   left_join(., coverage_all_drugs %>% 
#               filter(DRUG == the_drug) %>% 
#               filter(SPECIES == "Rabbit") %>% 
#               filter(LESIONNAME %notin% c("Caseum")) %>% 
#               group_by(DRUG) %>% 
#               summarise(MRT_TOTAL = sum(coverage_above_MRT))) %>% 
#   mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
#   mutate(LESIONNAME_header = case_when(LESIONNAME == "Plasma" ~ "Plasma PK\nover MIC",
#                                        LESIONNAME == "Lung" ~ "Lung PK\nover MacIC90",
#                                        LESIONNAME == "Cellular lesion" ~ "Cellular lesion PK\nover MacIC90",
#                                        LESIONNAME == "Caseum" ~ "Caseum PK\nover casMBC90")) %>%
#   mutate(LESIONNAME_header = factor(LESIONNAME_header, levels = c("Plasma PK\nover MIC",
#                                                                   "Lung PK\nover MacIC90",
#                                                                   "Cellular lesion PK\nover MacIC90",
#                                                                   "Caseum PK\nover casMBC90"))) %>% 
#   mutate(DOSE_mg = paste0(DOSE, " mg")) %>% 
#   mutate(DOSE_mg = fct_reorder(DOSE_mg, DOSE, min)) %>% 
#   ggplot(mapping = aes(x = TAD, y = DOSE_mg, fill= factor(coverage_above_MRT)))+
#   geom_point(shape = 22, size = 1.8, stroke = 0.2)+
#   theme_classic(base_size = 10)+
#   scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
#   facet_wrap(~DRUG, nrow=1)+
#   labs(y = "",
#        x = "")+
#   scale_fill_manual(values=c("white","steelblue4"), name="",
#                     labels=c("below target","above target"))+
#   theme(legend.background = element_rect("transparent"),
#       strip.background = element_rect("transparent"),
#       legend.text = element_text(size=5),
#       #legend.justification = c(1, 1),
#       #legend.position = c(1, 1),
#       legend.margin = margin(0,0,0,0.1),
#       legend.direction = "vertical",
#       legend.key.height = unit(0.005,'in'),
#       legend.key.size = unit(0.1,'in'),
#       legend.position = "none",
#       panel.grid.minor = element_blank(),
#       panel.grid = element_blank(),
#       axis.title = element_text(size = 7),
#       axis.text = element_text(size = 5),
#       # axis.title = element_blank(),
#       strip.text = element_text(size = 5,
#                                 margin = margin(0.1,0,0.05,0, "cm")),
#       plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
#   
#   
# })
# 
# pdf(paste0(WD,"manuscript/figures/drafts/", format(Sys.Date(), "%Y%m%d") ,"_coverage_sim_RABBIT_params_D-R_cas_only.pdf", sep =""), width = 6.5, height = 1)
# 
# grid.arrange(grobs = coverage_plot, nrow=1)
# 
# dev.off()



```

#### Coverage by regimen

Two panels per regimen, easy (plasma/MIC) versus hard (caseum/casMBC50)
```{r}

## BPaMZ ####
bpamz <- tibble(DRUG = c("BDQ", "MXF", "PMD",  "PZA"),
               DRUG_num = c(4,3,2,1))

coverage_all_drugs %>% 
  filter(DRUG %in% bpamz$DRUG) %>% 
  filter(SPECIES=="Rabbit") %>% 
  # filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., bpamz) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "BPaMZ")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

# ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_BPaMZ_Rabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)
```


##### Easy v hard to treat, separate plots

```{r}

## DBOS ####
dbos <- tibble(DRUG = c("DLM", "BDQ", "OPC-167832", "SZD"),
               DRUG_num = c(4,3,2,1))

coverage_all_drugs %>% 
  filter(DRUG %in% dbos$DRUG) %>% 
  filter(DOSE != 800 & DOSE !=1600) %>% 
 # filter(SPECIES=="Rabbit") %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., dbos) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG_LABEL, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_DBOS_Rabbit_ONLY.png", sep=""), width = 11, height = 1.5)

# plasma only
coverage_all_drugs %>% 
  filter(DRUG %in% dbos$DRUG) %>% 
  filter(DOSE != 800 & DOSE !=1600) %>% 
  filter(SPECIES=="Rabbit") %>% 
  # filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  filter(LESIONNAME %in% c("Plasma")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., dbos) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_DBOS_Rabbit_ONLY_easytotreat.png", sep=""), width = 4.5, height = 1.5)

coverage_all_drugs %>% 
  filter(DRUG %in% dbos$DRUG) %>% 
  filter(DOSE != 800 & DOSE !=1600) %>% 
  filter(SPECIES=="Rabbit") %>% 
  # filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  filter(LESIONNAME %in% c("Caseum")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., dbos) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_DBOS_Rabbit_ONLY_hardtotreat.png", sep=""), width = 4.5, height = 1.5)

## BPaMZ ####
bpamz <- tibble(DRUG = c("BDQ", "MXF", "PMD",  "PZA"),
               DRUG_num = c(4,3,2,1))

coverage_all_drugs %>% 
  filter(DRUG %in% bpamz$DRUG) %>% 
  filter(SPECIES=="Rabbit") %>% 
  filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., bpamz) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG_LABEL, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_BPaMZ_Rabbit_ONLY.png", sep=""), width = 11, height = 1.5)


# plasma only
coverage_all_drugs %>% 
  filter(DRUG %in% bpamz$DRUG) %>% 
  filter(SPECIES=="Rabbit") %>% 
  # filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., bpamz) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "BPaMZ")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_BPaMZ_Rabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)

coverage_all_drugs %>% 
  filter(DRUG %in% bpamz$DRUG) %>% 
  filter(SPECIES=="Rabbit") %>% 
  filter(LESIONNAME %in% c("Caseum")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., bpamz) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1)+
  labs(y = "",
       x = "Time after dose (hours)")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_BPaMZ_Rabbit_ONLY_hardtotreat.png", sep=""), width = 4.5, height = 1.5)


# CLOFAST
clofast <- tibble(DRUG = c("RPT", "PZA", "INH", "CFZ", "EMB"),
               DRUG_num = c(5,4,3,2,1))
# plasma only
coverage_all_drugs %>% 
  filter(DRUG %in% clofast$DRUG) %>% 
  filter(SPECIES=="Corrected \nRabbit") %>% 
  # filter(LESIONNAME %notin% c("Cavity wall", "Caseous lesion")) %>% 
  filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., clofast) %>% 
  
  #### need to update but EMB is INACTIVE in caseum, edit manually for now:
  mutate(coverage_above_MRT = ifelse(DRUG == "EMB" & LESIONNAME == "Hard-to-treat", 0, coverage_above_MRT)) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "CLO-FAST")+
  theme(strip.background = element_blank())+
  scale_fill_manual(values=c("white","steelblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_CLOFAST_Corrected_Rabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)


```

#### PK curves 

```{r corrected-pk-w-human-data-overlayed}

Human_PK_SIM_and_data <- lapply(all_human_obs$DRUG %>% unique(), function(drug){
  
  sim <- simulation_collect_all_drugs %>% 
                      mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
                      filter(DRUG == drug) %>% 
                      filter(SPECIES == "Corrected \nRabbit") %>% 
                      mutate(LESIONGROUP = case_when(LESIONNAME == "Cellular lesion" ~ "Cellular",
                                                  LESIONNAME == "Cavity wall" ~ "Cavity",
                                                  .default = LESIONNAME)) %>% 
                      mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
                      filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) # rm PLASMA (sim was built off data, not from rabbit)
  
  all_human_obs %>% 
    filter(DRUG == drug) %>% 
    filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) %>%
    mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
    mutate(c = "1") %>% # for color
    ggplot(mapping = aes(x = TIME, y = DV), color = "black")+
    geom_line(data = sim, aes(x = TAD, y = CLESION, color = "#88CCEE"), size = 1, inherit.aes = F)+
    stat_summary_bin(geom="line", fun = "median",breaks = c(-0.1, 4, 8, 12, 20, 24, 38), alpha = 0.4)+
    geom_point(size = 1, alpha = 0.4)+
    facet_wrap(~LESIONGROUP, nrow=1, scales = "free_y")+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    ylab(drug)+
    # scale_y_log10()+
    scale_x_continuous(breaks = seq(0, 36, 6), limits = c(0,NA))+
    scale_color_jco()+
    theme_bw()+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          legend.text = element_text(size=5),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          #legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          # legend.margin = margin(0,0,0,0),
          # legend.direction = "vertical",
          # legend.key.height = unit(0.005,'in'),
          # legend.title = element_blank(),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 8),
          axis.title = element_text(size = 10),
          axis.title.x = element_blank(),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 6,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
  
  
  
})

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Human_PK_SIM_and_data.pdf", sep =""), width = 6.5, height = 8)

grid.arrange(grobs = Human_PK_SIM_and_data, nrow=7,
             bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=10)),
             left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=10), rot = 90))

dev.off()

# NEXT STEP:
# - can use EBE for each patient
# - variability
# - DV v PRED plot

```

```{r corrected-pk-w-human-data-overlayed_by_lesion}

# by LESIONGROUP (col = drug, row = LESIONGROUP)

lesion_group_list <- c("Lung", "Cellular", "Caseum")

Human_PK_SIM_and_data_by_lesion <- lapply(lesion_group_list, function(lesiongroup){
  
  sim <- simulation_collect_all_drugs %>% 
                      mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
                      filter(DRUG %in% drug_list) %>% 
                      filter(SPECIES == "Corrected \nRabbit") %>% 
                      mutate(LESIONGROUP = case_when(LESIONNAME == "Cellular lesion" ~ "Cellular",
                                                  LESIONNAME == "Cavity wall" ~ "Cavity",
                                                  .default = LESIONNAME)) %>% 
                      mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
                      filter(LESIONGROUP %in% lesiongroup) 
  
  all_human_obs %>% 
    filter(DRUG %in% drug_list) %>% 
    filter(LESIONGROUP %in% lesiongroup) %>% 
    mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
    mutate(c = "1") %>% # for color
    ggplot(mapping = aes(x = TIME, y = DV), color = "black")+
    geom_line(data = sim, aes(x = TAD, y = CLESION, color = "#88CCEE"), size = 1, inherit.aes = F)+
   # stat_summary_bin(geom="line", fun = "median",breaks = c(-0.1, 4, 8, 12, 20, 24, 38), alpha = 0.4)+
    geom_point(size = 1, alpha = 0.4)+
    facet_wrap(~DRUG, nrow=1, scales = "free_y")+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    ylab(lesiongroup)+
    # scale_y_log10()+
    scale_x_continuous(breaks = seq(0, 36, 12), limits = c(0,NA))+
    scale_color_jco()+
    theme_bw()+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          strip.text.x = element_blank(),
          legend.text = element_text(size=5),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          #legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          # legend.margin = margin(0,0,0,0),
          # legend.direction = "vertical",
          # legend.key.height = unit(0.005,'in'),
          # legend.title = element_blank(),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 6),
          axis.title = element_text(size = 8),
          axis.title.x = element_blank(),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 6,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
  
  
  
})

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Human_PK_SIM_and_data_2.pdf", sep =""), width = 6.8, height = 3.5)

fig4_bot <- grid.arrange(grobs = Human_PK_SIM_and_data_by_lesion, nrow=3,
             bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=8)),
             left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=8), rot = 90),
             top = textGrob(c( "CFZ INH KAN LZD MXF PZA RIF"), gp=gpar(fontsize=6)))

fig4_bot 

dev.off()



```



```{r dv-v-pred}
# CHECK THE DOSES USED IN SIMULATIONS
# LONGER SIMS TO ACCOUNT FOR TAD UP TO 31 HOURS
# make dfs of pred and dv and join by DRUG and LESIONGROUP

dv_pred_df <- left_join(
  
  simulation_collect_all_drugs %>% 
                      filter(DRUG %in% drug_list) %>% 
                      mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
                      filter(SPECIES == "Corrected \nRabbit") %>% 
                      mutate(LESIONGROUP = case_when(LESIONNAME == "Cellular lesion" ~ "Cellular",
                                                  LESIONNAME == "Cavity wall" ~ "Cavity",
                                                  .default = LESIONNAME)) %>% 
                      filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) %>% 
                      mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
    select(DRUG, TAD, LESIONGROUP, CLESION), 

  all_human_obs %>% 
            filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) %>%
            mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
    select(DRUG, TAD, LESIONGROUP, DV) %>%
    mutate(TAD = ifelse(TAD >= 24, 24, round(TAD,0))) %>% #round to closeset integer to match sim
    group_by(DRUG, TAD, LESIONGROUP) %>% 
    summarise(medDV = median(DV),
              lower = quantile(DV, 0.25),
              upper = quantile(DV, 0.75)) 
) 
  
plt_no_log <- dv_pred_df %>% 
  ggplot(aes(CLESION,medDV, fill = DRUG, shape = LESIONGROUP))+
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.03, linewidth=0.2)+
  geom_point(size = 1)+
  geom_abline(slope=1, linetype=2)+
  scale_color_manual(values = DRUG_color_map)+
  xlab("Prediction")+
  ylab("Observation")+
  scale_shape_manual(values=c(21,22,23,24,25),name="")+
  scale_color_manual(name="", values=DRUG_color_map)+
  scale_fill_manual(name="", values=DRUG_color_map)+
  ggtitle("Model predictions versus Observations")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text=element_text(size=10),
        legend.key.height = unit(0.11,'in'),
        legend.key.size = unit(0.1,'in'))+
  theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          strip.text.x = element_blank(),
          legend.text = element_text(size=5),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 6),
          axis.title = element_text(size = 8),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))+
          guides(fill=guide_legend(override.aes=list(shape=21),size="none"))


plt_log10 <- plt_no_log+ scale_y_log10()+scale_x_log10()
plt_no_log
plt_log10

plt_no_log_no_pza <- dv_pred_df %>% 
  filter(DRUG %notin% c("PZA")) %>% 
  ggplot(aes(CLESION,medDV, fill = DRUG, shape = LESIONGROUP))+
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.03, linewidth=0.2)+
  geom_point(size = 1)+
  geom_abline(slope=1, linetype=2)+
  scale_color_manual(values = DRUG_color_map)+
  xlab("Prediction")+
  ylab("Observation")+
  scale_shape_manual(values=c(21,22,23,24,25),name="")+
  scale_color_manual(name="", values=DRUG_color_map)+
  scale_fill_manual(name="", values=DRUG_color_map)+
  ggtitle("Model predictions versus Observations")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text=element_text(size=10),
        legend.key.height = unit(0.11,'in'),
        legend.key.size = unit(0.1,'in'))+
  theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          strip.text.x = element_blank(),
          legend.text = element_text(size=5),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 6),
          axis.title = element_text(size = 8),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))+
          guides(fill=guide_legend(override.aes=list(shape=21),size="none"))


plt_log10_no_pza <- plt_no_log_no_pza+ scale_y_log10()+scale_x_log10()

plt_no_log_no_pza
plt_log10_no_pza


pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Model_pred_v_dv.pdf", sep =""), width = 3, height = 3)
plt_no_log
dev.off()

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Model_pred_v_dv_log10.pdf", sep =""), width = 3, height = 3)
plt_log10
dev.off()

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Model_pred_v_dv_no_pza.pdf", sep =""), width = 3, height = 3)
plt_no_log_no_pza
dev.off()

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Model_pred_v_dv_log10_no_pza.pdf", sep =""), width = 3, height = 3)
plt_log10_no_pza
dev.off()
```

```{r fig4-patwork-v2}

fig4_top <- ggarrange(species_corr, test_set_res, plt_no_log,nrow=1, common.legend = T, legend = "right")

fig4_top

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Fig4_patchwork.pdf", sep =""), width = 6.8, height = 4.5)

fig4_top / fig4_bot +plot_layout(nrow = 2 , heights = c(1,1.5))

dev.off()

```


```{r fig4-patwork-v3}

# Panel A and B only
# fig4_top <- ggarrange(species_corr, test_set_res, nrow=1, common.legend = T, legend = "right")

fig4_top <- ggarrange(species_corr, test_set_res, nrow=1, common.legend = T, legend = "right")

fig4_top

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Fig4_patchwork_Panel_AB_only.pdf", sep =""), width = 6.5, height = 3)

fig4_top 

dev.off()

```

```{r fig4-patchwork-v4}

fig4_top <- ggarrange(species_corr, test_set_res)#, common.legend = T, legend = "right")

fig4_top + plot_spacer() / part_plt +plot_layout(nrow = 2 , heights = c(2,1,2))


```


# Fig 4 patchwork
```{r}
# pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Fig4_patchwork.pdf", sep =""), width = 6.8, height = 9)
# 
# fig4_top / fig4_bot +plot_layout(nrow = 4 , heights = c(1.5,1.5,1,1))
# 
# dev.off()
```

```{r rabbit-pk-w-human-data-overlayed}

Human_PK_SIM_and_data_2 <- lapply(all_human_obs$DRUG %>% unique(), function(drug){
  
  sim <- simulation_collect_all_drugs %>% 
                      mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
                      filter(DRUG == drug) %>% 
                      filter(SPECIES == "Rabbit") %>% # the difference from above chunk (!)
                      mutate(LESIONGROUP = case_when(LESIONNAME == "Cellular lesion" ~ "Cellular",
                                                  LESIONNAME == "Cavity wall" ~ "Cavity",
                                                  .default = LESIONNAME)) %>% 
                      mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
                      filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) # rm PLASMA (sim was built off data, not from rabbit)
  
  all_human_obs %>% 
    filter(DRUG == drug) %>% 
    filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) %>%
    mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
    mutate(c = "1") %>% # for color
    ggplot(mapping = aes(x = TIME, y = DV), color = "black")+
    geom_line(data = sim, aes(x = TAD, y = CLESION, color = "#88CCEE"), size = 1, inherit.aes = F)+
    stat_summary_bin(geom="line", fun = "median",breaks = c(-0.1, 4, 8, 12, 20, 24, 38), alpha = 0.4)+
    geom_point(size = 1, alpha = 0.4)+
    facet_wrap(~DRUG, nrow=1, scales = "free_y")+
    # xlab("Time after last dose (h)")+
    # ylab("Concentration (ng/g)")+
    ylab(drug)+
    # scale_y_log10()+
    scale_x_continuous(breaks = seq(0, 36, 6), limits = c(0,NA))+
    scale_color_jco()+
    theme_bw()+
    theme(legend.background = element_rect("transparent"),
          strip.background = element_rect("transparent"),
          legend.text = element_text(size=5),
          # legend.justification = c(1, 1),
          # legend.spacing.y = unit(0, 'cm'),
          # legend.position = c(1, 0.98),
          #legend.justification = c("left", "bottom"),
          # legend.box.just = "left",
          # legend.margin = margin(0,0,0,0),
          # legend.direction = "vertical",
          # legend.key.height = unit(0.005,'in'),
          # legend.title = element_blank(),
          legend.position = "none",
          panel.grid.minor = element_blank(),
          panel.grid = element_blank(),
          # axis.title = element_text(size = 7),
          axis.text = element_text(size = 8),
          axis.title = element_text(size = 10),
          axis.title.x = element_blank(),
          strip.text = element_text(size = 8,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.title = element_text(size = 6,
                                    margin = margin(0.1,0,0.05,0, "cm")),
          plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
  
  
  
})

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Human_PK_SIM_and_data_RABBIT.pdf", sep =""), width = 6.5, height = 8)

grid.arrange(grobs = Human_PK_SIM_and_data_2, nrow=7,
             bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=10)),
             left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=10), rot = 90),
             common.legend = TRUE, legend="bottom")

dev.off()

```

```{r corrected-pk-w-human-data-overlayed}

Human_PK_SIM_and_casMBC50 <- lapply(simulation_collect_all_drugs$DRUG %>% unique(), function(drug){

  casMBC50_mgL_value <- casMBC50_df %>% 
    mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
    filter(DRUG == drug) %>% 
    pull(casMBC50_mgL)
  
  simulation_collect_all_drugs %>% 
                      mutate(DRUG = ifelse(DRUG == "INH_i", "INH", DRUG)) %>% 
                      filter(DRUG == drug) %>% 
                      filter(SPECIES == "Corrected \nRabbit") %>% 
                      mutate(LESIONGROUP = case_when(LESIONNAME == "Cellular lesion" ~ "Cellular",
                                                  LESIONNAME == "Cavity wall" ~ "Cavity",
                                                  .default = LESIONNAME)) %>% 
                      mutate(LESIONGROUP = factor(LESIONGROUP, levels = LESIONGROUP_levels)) %>% 
                      filter(LESIONGROUP %in% c("Lung", "Cellular", "Caseum")) %>% 
    dim()
    # ggplot(aes(x = TAD, y = CLESION, group = DOSE, color = factor(DOSE)))+
    # geom_line(size=1)+
    # geom_hline(yintercept = casMBC50_mgL_value, size = 1, linetype=2, color ="darkred")+
    # facet_wrap(~LESIONGROUP, nrow=1, scales = "free_y")+
    # # xlab("Time after last dose (h)")+
    # # ylab("Concentration (ng/g)")+
    # ylab(drug)+
    # # scale_y_log10()+
    # scale_x_continuous(breaks = seq(0, 36, 6), limits = c(0,NA))+
    # scale_color_jco()+
    # theme_bw()+
    # theme(legend.background = element_rect("transparent"),
    #       strip.background = element_rect("transparent"),
    #       legend.text = element_text(size=5),
    #       # legend.justification = c(1, 1),
    #       # legend.spacing.y = unit(0, 'cm'),
    #       # legend.position = c(1, 0.98),
    #       #legend.justification = c("left", "bottom"),
    #       # legend.box.just = "left",
    #       # legend.margin = margin(0,0,0,0),
    #       # legend.direction = "vertical",
    #       # legend.key.height = unit(0.005,'in'),
    #       # legend.title = element_blank(),
    #       legend.position = "none",
    #       panel.grid.minor = element_blank(),
    #       panel.grid = element_blank(),
    #       # axis.title = element_text(size = 7),
    #       axis.text = element_text(size = 8),
    #       axis.title = element_text(size = 10),
    #       axis.title.x = element_blank(),
    #       strip.text = element_text(size = 8,
    #                                 margin = margin(0.1,0,0.05,0, "cm")),
    #       plot.title = element_text(size = 6,
    #                                 margin = margin(0.1,0,0.05,0, "cm")),
    #       plot.margin = unit(c(0.1,0.2,0.1,0.1), "cm"))
    # 
    # 
    # 
})

# pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_Human_PK_SIM_and_casMBC50.pdf", sep =""), width = 6.5, height = 8)
# 
# grid.arrange(grobs = Human_PK_SIM_and_casMBC50, nrow=7,
#              bottom = textGrob("Time after dose (h)", gp=gpar(fontsize=10)),
#              left = textGrob("Concentration (mg/L)", gp=gpar(fontsize=10), rot = 90))
# 
# dev.off()

```

# Summary statistics of clinical simulations
### Dose	Cmax	Tmax	AUC(0-t or 0-24)	AUC(0-inf)	CL or CL/F	V
```{r}

time_range <- simulation_collect_all_drugs$TIME %>% range()

sum <- simulation_collect_all_drugs %>% 
  filter(SPECIES == "Corrected \nRabbit") %>% 
  filter(LESIONNAME == "Plasma") %>% 
  group_by(DRUG, DOSE) %>% 
  filter(CP == max(CP)) %>% 
  mutate(Cmax = round(CP,2),
         Tmax = TAD) %>% 
  left_join(., simulation_collect_all_drugs %>% 
                filter(SPECIES == "Corrected \nRabbit") %>% 
                filter(LESIONNAME == "Plasma") %>% 
                group_by(DRUG, DOSE) %>% 
                filter(TIME %in% time_range) %>% 
                mutate(AUCss_0_24 = round(AUC - lag(AUC),2)) %>% 
                drop_na(),
            by = c("DRUG", "DOSE")) %>% 
  left_join(., simulation_collect_all_drugs %>% 
              filter(SPECIES == "Corrected \nRabbit") %>% 
              filter(LESIONNAME == "Plasma") %>% 
              filter(TIME == 288) %>% # predose 
              mutate(Cmin = round(CP,2)),
          by = c("DRUG", "DOSE")) %>% 
  select(DRUG, DOSE, Cmax, Tmax, AUCss_0_24, Cmin) %>% 
  arrange(DRUG)

sum2 <- left_join(sum, x %>% 
                    mutate(DRUG = ifelse(drug == "SZD", "SUT", drug)) %>% 
                    distinct(DRUG,CL,V, clinical_PK_ref), by="DRUG")

#write.csv(sum2, "TB_PK_parameters_20240924.csv", row.names = F)  

```


### All matrices - Dose	Cmax	Tmax	AUC(0-t or 0-24)	AUC(0-inf)	CL or CL/F	V
```{r}

time_range <- simulation_collect_all_drugs$TIME %>% range()

sum <- simulation_collect_all_drugs %>% 
  filter(SPECIES == "Corrected \nRabbit") %>% 
  group_by(DRUG, DOSE, LESIONNAME) %>% 
  filter(CLESION == max(CLESION)) %>% 
  mutate(Cmax = round(CLESION,2),
         Tmax = TAD) %>% 
  left_join(., simulation_collect_all_drugs %>% 
                filter(SPECIES == "Corrected \nRabbit") %>% 
                group_by(DRUG, DOSE, LESIONNAME) %>% 
                filter(TIME %in% time_range) %>% 
                mutate(AUCss_0_24 = round(AUCL - lag(AUCL),2)) %>% 
                drop_na(),
            by = c("DRUG", "DOSE", "LESIONNAME")) %>% 
  left_join(., simulation_collect_all_drugs %>% 
              filter(SPECIES == "Corrected \nRabbit") %>%
              group_by(DRUG, DOSE, LESIONNAME) %>% 
              filter(TIME == 288) %>% # predose 
              mutate(Cmin = round(CLESION,2)),
          by = c("DRUG", "DOSE", "LESIONNAME")) %>% 
  select(DRUG, DOSE, LESIONNAME, Cmax, Tmax, AUCss_0_24, Cmin) %>% 
  arrange(DRUG)

write.csv(sum, "TB_PK_parameters_20240925_all_lesions.csv", row.names = F)  

```


# Request for rabbit Tmax of MXF

```{r}
all_rabbit_obs %>% 
  filter(DRUG == "MXF") %>% 
  filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
  ggplot(aes(x = TAD, y = DV, color=factor(DOSE)))+
  geom_point(alpha=0.2)+
  stat_summary_bin(geom="line", fun = median, breaks = c(0.5,seq(0,24,1)))+
  xlab("Time after dose (h)")+
  ylab("Concentration (mg/L)")+
  scale_color_manual(values=COLOR_map, name="Dose (mg/kg)")+
  scale_x_continuous(breaks = seq(0,24,4))+
  facet_wrap(~LESIONGROUP, ncol=4, scales = "free_y")+
  theme(panel.grid = element_blank(),
        legend.title = element_text("Dose"),
        strip.background = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position=c(1,1),
        legend.justification=c(1,1), 
        legend.key.width=unit(1, "lines"), 
        legend.key.height=unit(1, "lines"))

tmax_df_prep <- all_rabbit_obs %>% 
  filter(DRUG == "MXF") %>% 
  filter(LESIONGROUP %in% c("Plasma", "Lung", "Cellular", "Caseum")) %>% 
  mutate(TAD_bin = ifelse(TAD < 1, 0.5, round(TAD,0))) 

tmax_df_prep %>% distinct(TAD, TAD_bin, LESIONGROUP, DOSE,DV) %>% View()
  
tmax_df <- tmax_df_prep %>% 
  group_by(DOSE, LESIONGROUP, TAD_bin) %>%
  reframe(medDV = median(DV)) %>% 
  group_by(DOSE, LESIONGROUP) %>%
  filter(medDV == max(medDV)) %>% 
  rename(Cmax = medDV,
         Tmax = TAD_bin) 

tmax_df_wide <- tmax_df %>% 
  select(-Cmax) %>% 
  mutate(DOSE = paste0("Tmax_",DOSE,"_mgkg")) %>% 
  pivot_wider(names_from = DOSE,
              values_from = Tmax)

tmax_sum <- tmax_df %>% 
              group_by(LESIONGROUP) %>% 
              summarise(min_Tmax = min(Tmax),
                        max_Tmax = max(Tmax)) %>% 
              left_join(., tmax_df %>% filter(DOSE == 100) %>% 
                          rename(Tmax_100mgkg = Tmax) %>% 
                          ungroup() %>% 
                        select(LESIONGROUP, Tmax_100mgkg)) %>% distinct()

#write.csv(tmax_df_wide, "~/Downloads/MXF_rabbit_Tmax_sum.csv", row.names = F)
#write.csv(tmax_df %>% filter(LESIONGROUP == "Plasma"), "~/Downloads/MXF_rabbit_Tmax_plasma.csv", row.names = F)
 
   
```

# Request for simulations of CFZ (rada - 20230926)

```{r}

simulation_collect_all_drugs %>% 
  filter(DRUG == "CFZ") %>% 
  filter(SPECIES == "Rabbit") %>% 
  filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
  #mutate(SPECIES = ifelse(SPECIES == "Corrected \nRabbit", "Scaled", SPECIES)) %>%
  ggplot(aes(TAD, CLESION*1000))+
  geom_line(color="#00A1D5FF")+
  geom_hline(yintercept = casMBC50_df %>% filter(DRUG == "CFZ") %>% pull(casMBC50_mgL)*1000, linetype="dashed", color = "darkred")+
  annotate(geom = "text", label = "caseum MBC50", color = "darkred", x=16, y=3500, hjust=0)+
  geom_ribbon(aes(TAD, ymin=CLESION*1000 /10, ymax = CLESION*1000 * 2, alpha = 0.01, fill = "#00A1D5FF"))+
  facet_wrap(~LESIONNAME, nrow=1)+
  xlab("Time (days)")+
  ylab("Concentration (ng/mL)")+
  scale_x_continuous(breaks = seq(0,24,4))+
  guides(alpha="none", fill="none")+
  theme(strip.background = element_blank(),
        panel.grid = element_blank())

ggsave(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_CFZ.pdf", sep =""), plot = last_plot(),
       width = 4*2, height = 3*1.5)

```



# Rabbit VPCs

```{r gsk656_vpc}

drug <- "GSK-656"

WDvpc <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Priority_drugs/GSK656_rabbit_PK/"
wdnm <- "nm/final/"

setwd(paste0(WDvpc,wdnm))

runno <- "100"
cmt <- "Plasma"

a <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
             obs_cols = list(idv = "TAD"),
             sim_cols = list(idv = "TAD"),
             bins = "pretty",
             pred_corr = T,
             show = list(obs_dv =T, obs_ci = F,
                         pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L01c"
cmt <- "Lung"

b <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
             obs_cols = list(idv = "TAD"),
             sim_cols = list(idv = "TAD"),
             bins = "pretty",
             pred_corr = T,
             show = list(obs_dv =T, obs_ci = F,
                         pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L02d"
cmt <- "Cellular"

c <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
             obs_cols = list(idv = "TAD"),
             sim_cols = list(idv = "TAD"),
             bins = "pretty",
             pred_corr = T,
             show = list(obs_dv =T, obs_ci = F,
                         pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")


runno <- "L03d"
cmt <- "Caseum"

d <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
             obs_cols = list(idv = "TAD"),
             sim_cols = list(idv = "TAD"),
             bins = "pretty",
             pred_corr = T,
             show = list(obs_dv =T, obs_ci = F,
                         pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

gsk656_vpc <- arrangeGrob(a,b,c,d, top=drug)

```


```{r gtx_vpc}

drug <- "GTX"

WDvpc <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Priority_drugs/GTX_rabbit_PK/"
wdnm <- "nm/final/"

setwd(paste0(WDvpc,wdnm))

runno <- "121_CLint"
cmt <- "Plasma"

a <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "121_1a_linear"
cmt <- "Lung"

b <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "121_2a_linear"
cmt <- "Cellular"

c <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")


runno <- "121_3a_linear"
cmt <- "Caseum"

d <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

gtx_vpc <- arrangeGrob(a,b,c,d, top=drug)
```


```{r inh_vpc}
drug <- "INH"

WDvpc <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Clinical_validation/Validation_set_rabbit/INH_rabbit_PK/"
wdnm <- "nm/final/"

setwd(paste0(WDvpc,wdnm))

runno <- "07"
cmt <- "Plasma"

a <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "jenks",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,6))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L01"
cmt <- "Lung"

b <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "jenks",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,6))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L02"
cmt <- "Cellular"

c <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "jenks",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,6))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L08d"
cmt <- "Caseum"

d <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "jenks",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,6))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

inh_vpc <- arrangeGrob(a,b,c,d, top=drug)

```



```{r pmd_vpc}

drug <- "PMD"

WDvpc <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Priority_drugs/PMD_rabbit_PK/"
wdnm <- "nm/archive/"

setwd(paste0(WDvpc,wdnm))

runno <- "13"
cmt <- "Plasma"

a <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = c(0,2,4,6,8,10,12,24),
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L01"
cmt <- "Lung"

b <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L02a"
cmt <- "Cellular"

c <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = c(-1,1,3,15,24),
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "L03b"
cmt <- "Caseum"

d <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = c(-1,4,16,24),
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

pmd_vpc <- arrangeGrob(a,b,c,d, top=drug)

```


```{r szd_vpc}

drug <- "SZD"

# needs :                   stratify = "METAB",

WDvpc <- "~/Dropbox/TB_translation/Projects/Rabbit_lesion_PK/Priority_drugs/SZD_rabbit_PK/"
wdnm <- "nm/final/"

setwd(paste0(WDvpc,wdnm))

runno <- "73"
cmt <- "Plasma"

a <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  pred_corr = T,
                  stratify = "METAB",
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  facet_wrap(~METAB, scales = "free", labeller = labeller(METAB = c("1" = "SZD",
                                                                    "2" = "SZD-M1")))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank(),
        strip.background = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "27"
cmt <- "Lung"

b <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  stratify = "METAB",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  facet_wrap(~METAB, scales = "free", labeller = labeller(METAB = c("1" = "SZD",
                                                                    "2" = "SZD-M1")))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank(),
        strip.background = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")

runno <- "30"
cmt <- "Cellular"

c <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  bins = "pretty",
                  stratify = "METAB",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  facet_wrap(~METAB, scales = "free", labeller = labeller(METAB = c("1" = "SZD",
                                                                    "2" = "SZD-M1")))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank(),
        strip.background = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")


runno <- "31"
cmt <- "Caseum"

d <- vpc::vpc_vpc(psn_folder = paste0(WDvpc, wdnm, 'run', runno, 'vpc-idv'),
                  obs_cols = list(idv = "TAD"),
                  sim_cols = list(idv = "TAD"),
                  stratify = "METAB",
                  bins = "pretty",
                  pred_corr = T,
                  show = list(obs_dv =T, obs_ci = F,
                              pi = T, pi_as_area = T))+
  facet_wrap(~METAB, scales = "free", labeller = labeller(METAB = c("1" = "SZD",
                                                                    "2" = "SZD-M1")))+
  theme_bw( base_size = 8)+
  theme(panel.grid = element_blank(),
        strip.background = element_blank())+
  scale_x_continuous(breaks = seq(0,120,12))+
  labs(title = cmt, caption = NULL, subtitle = NULL,
       x = "Time after dose (h)",
       y = "Prediction-Corrected\nConcentration (mg/L)")
 
szd_vpc <- arrangeGrob(a,b,c,d, top=drug)

```



```{r rabbit-vpc-all}

pdf(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,"_RABBIT_VPC_ALL.pdf", sep =""), width = 6.5, height = 8)

grid.arrange(arrangeGrob(gsk656_vpc,
             gtx_vpc,
             inh_vpc,
             pmd_vpc),
             szd_vpc,
             nrow=2,
             heights = 2:1)

dev.off()
```


# TBDA 2023 
## Take all Caseum PK / casMBC50 for all regimens in Ph3 trials
```{r}

# comment out and use `sim_df` from load simulated data chunk
# sim_df <- simulation_collect_all_drugs %>%
#   mutate(DRUG = ifelse(DRUG == "INH_s", "INH",DRUG )) %>%
#   mutate(SPECIES = ifelse(SPECIES == "Corrected \nRabbit", "Corrected Rabbit", SPECIES))
# 
# target_labels <- drug_potency_MRT2 %>%
#   select( DRUG, DRUG_name_long, LESIONNAME, MW, contains("mgL")) %>%
#   pivot_longer(cols = contains("mgL"), names_to = "LABEL", values_to = "TARGET")
# 
# sim_df <- sim_df %>% left_join(., target_labels) %>% mutate(LESIONNAME = factor(LESIONNAME, levels = lesion_level))
# 
# sim_df %>% filter(LABEL == "casMBC50_mgL_char_7") %>% drop_na() %>% pull(DRUG) %>% unique()

coverage_all_drugs_REG_PLOTS <- sim_df %>% 
  #filter(SPECIES == "Corrected Rabbit") %>% 
  filter(LESIONNAME %in% c("Caseum")) %>% 
  filter(LABEL == "casMBC50_mgL_char_7") %>% 
  mutate(TARGET = ifelse(DRUG=="SZD-M1", 29.6, TARGET)) %>% # Ex_Vivo_Caseum_Assay.Rmd (20230726_conc-response_FIXGAMMA_log10)
  mutate(TARGET = ifelse(DRUG=="EMB", 100, TARGET)) %>% # add targets for those that are NA
  #filter(TIME<264+24) %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  group_by(ROW_ID) %>% 
  summarise(hours_total_per_ROW_ID = sum(coverage_above_MRT)) 

coverage_all_drugs_REG_PLOTS$ROW_ID



BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24")
HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24")
BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24")
BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24")
BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24")
RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24")
HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24")
R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24")
HRZG  = c("RIF_600_mg_24","PZA_1500_mg_24","GTX_400_mg_24","INH_s_300_mg_24")


regimen_df <- 
  
  bind_rows(
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaMZ | Simplici-TB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% RZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZG | OFLOTUB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% PaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PaMZ | STAND"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PMZ | S31/A5349, with H"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZE | S31/A5349"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HRZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZE | Standard-of-care"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZEC) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZEC | CLO-FAST"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BLZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BLZ"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaL) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaL | Nix/ZeNix"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaLM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaLM | TB-PRACTECAL"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% RZME) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZME | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HRZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZM | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R15HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R15HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R20HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R20HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R40HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID) +8) %>% # 8 placeholder. do sim for hi RIF 1800 mg? 
      mutate(Regimen = "R40HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% RZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZM | REMoxTB")
    

)

#write.csv(regimen_df, "~/Dropbox/SavicMisc/PRES_May2024_CRUSH_UNITE4TB_PARADIGM/Lesion_ranked_regimens.csv", row.names = F)
```

### OPERATIONALIZE 
```{r}


regimens <- list(
  
  #known outcome
  BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24"),
  HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24"),
  BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24"),
  BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24"),
  RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24"),
  HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24"),
  #OFLOTUB
  HRZG  = c("RIF_600_mg_24","PZA_1500_mg_24","GTX_400_mg_24","INH_s_300_mg_24"), 
  
  #RIFASHORT COMPARE WITH MOUSE REGIMEN
  R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24"),
  
  #RIFASHORT COMPARE WITH CLIN OUTCOME
  R1200HZE = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  R1800HZE = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  
  #novel regimens: Notes can't use Rb and G8 (Rb modeling not completed, G8 follower of GSK656- ok to use 656?)
  #G8 probably inactive (like 656)
  # BMZRb = 
  BMZ = c("BDQ_400_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  BPaUG8 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  BPaUG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BOUG2 = c("BDQ_400_mg_24", "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaOU = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BDOG2 = c("BDQ_400_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24"), #G2 inactive
  BDUG2 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BPaOG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24"), #G2 inactive
  BDOU = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  DBO  = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"),
  BDUG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  PaOUG2 = c("PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  DOUG2 = c("DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BDOG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"), #G8 probably inactive
  
  #NC-009
  S8_25_PaL   = c("TBAJ-876_25_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  S8_50_PaL   = c("TBAJ-876_50_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  S8_100_PaL  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  
  #other interesting regimens to predict:
  R40MHZ = c("RIF_1800_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  S8_100_PaOU = c("TBAJ-876_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_PaOU = c("TBAJ-587_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8_100_DOU = c("TBAJ-876_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_DOU = c("TBAJ-587_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  
  #wave 2023 part B
  S8_100_PaG6U = c("TBAJ-587_100_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G6 inactive
  S8_100_DG6U = c("TBAJ-587_100_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaG6U    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaUG8    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaG6G2   = c("BDQ_400_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24"),
  
  #CRUSH-TB
  BMZRb   = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "RBT_300_mg_24"),
  BMZD    = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "DLM_100_mg_12"), # add"DLM_300_mg_24"
  
  #CRUSH-TB potential wave 2
  S8MZRb  = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "RBT_300_mg_24"),
  S8ZMD   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "DLM_100_mg_12"),
  S8ZMU   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMU  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMRb = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "RBT_300_mg_24"),
  # S8PaMA  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", ), #don't have A
  S8PaMO  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "OPC-167832_30_mg_24"),

  
  #UNITE4TB - PARADIGM4TB
  # A) HRZE/HR (Isoniazid + rifampicin + pyrazinamide + ethambutol for 8 weeks then isoniazid + rifampicin for 16 weeks)
  # B) BDM (Bedaquiline + delamanid + moxifloxacin)
  # C) BDMG6 (Bedaquiline + delamanid + moxifloxacin + GSK-656)
  # D) BDZG6 (Bedaquiline + delamanid + pyrazinamide + GSK-656)
  # E) BDLG6 Bedaquiline + delamanid + linezolid** + GSK-656
  # F) BPaMG6 (Bedaquiline + pretomanid + moxifloxacin + GSK-656)
  # G) BDMT (Bedaquiline + delamanid + moxifloxacin + BTZ-043)
  # H) BDZT (Bedaquiline + delamanid + pyrazinamide + BTZ-043)
  # I) BDLT (Bedaquiline + delamanid + linezolid** + BTZ-043)
  # J) BPaMT (Bedaquiline + pretomanid + moxifloxacin + BTZ-043)
  # K) BMZT (Bedaquiline + moxifloxacin + pyrazinamide + BTZ-043)
  # L) BDG6T (Bedaquiline + delamanid + GSK-656 + BTZ-043***)
  BDM     = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24"),
  BDMG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDZG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "GSK-656_20_mg_24"),
  BDLG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "GSK-656_20_mg_24"),
  BPaMG6  = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDMT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BDZT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDLT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "BTZ-043_1250_mg_24"),
  BPaMT   = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BMZT    = c("BDQ_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDG6T   = c("BDQ_200_mg_24", "DLM_100_mg_12", "GSK-656_20_mg_24", "BTZ-043_1250_mg_24")
  
  
  
  
  
  

)

# Create a df with hours_total for each regimen (hours_total = total hours above casMBC50 in caseum)
regimen_coverage_all <- NULL

for (i in 1:length(regimens)) {
  
  regimen_coverage_all <- bind_rows(regimen_coverage_all,
                                    coverage_all_drugs_REG_PLOTS %>% 
                                      filter(ROW_ID %in% regimens[[i]] %>% unlist()) %>%
                                      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
                                      mutate(Regimen = names(regimens)[i])
  )
  
}

#write out fo tbda 20231031
# write.csv(regimen_coverage_all, 
#           "~/Dropbox/SavicMisc/TBDA_2023_Oct/20231117_Lesion_ranked_regimens_WITH_NEW_REGIMENS.csv", 
#           row.names = F)

#write out for April 2024 meeting
# write.csv(regimen_coverage_all,
#           "~/Dropbox/SavicMisc/TBDA_2023_Oct/20240409_Lesion_ranked_regimens_with_Wave2023b.csv",
#           row.names = F)

#write out for April 2024 meeting
# write.csv(regimen_coverage_all,
#           "~/Dropbox/SavicMisc/PRES_May2024_CRUSH_UNITE4TB_PARADIGM/20240514_Lesion_ranked_regimens_with_CRUSH_UNITE4TB_PARADIGM.csv",
#           row.names = F)
```

## Number of drugs in caseum plot (Figure 5 manuscript)

```{r}

# lesion_ranked_regimens <- read.csv("~/Dropbox/SavicMisc/TBDA_2023_Oct/Lesion_ranked_regimens.csv") %>%
#   rename(Predictor = Regimen) %>% 
#   mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor))

lesion_ranked_regimens <- regimen_df %>%
  rename(Predictor = Regimen) %>% 
  mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor)) %>% 
  mutate(Outcome = ifelse(hours_total >= 48 & Predictor != "PaMZ | STAND", 1, 0))

clinical_regimen_outcome <- lesion_ranked_regimens %>% select(Predictor, Outcome)

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_by_N_drug_color_by_outcome.png'), units = "in",res = 300,
     height = 2.5, width = 6)

lesion_ranked_regimens %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "BLZ") %>% 
  filter(Predictor != "RZM | REMoxTB") %>% 
  mutate(no_of_drugs = ifelse(hours_total==0, 0, (hours_total-1)/24)) %>% 
  arrange(rev(Predictor)) %>% 
  mutate(Predictor = fct_reorder2(Predictor, Outcome, no_of_drugs, .desc=T)) %>% 
  mutate(Predictor = fct_rev(Predictor)) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = no_of_drugs, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = rev(c("#87AE73", "grey")))+
  guides(fill="none")+
  ylab("")+
  xlab("Number of drugs in the regimen\nthat meet the PK-PD target in caseum")+
  theme_bw()+
  theme(axis.text.y = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()



```

```{r}

unite4tb <- c("BDM", "BDMG6", "BDZG6", "BDLG6", "BPaMG6", "BDMT", "BDZT", "BDLT", "BPaMT", "BMZT", "BDG6T")
nc009    <- c("S8_25_PaL", "S8_50_PaL", "S8_100_PaL")
crushtb  <- c("BMZRb", "BMZD")
pantb    <- c("BPaOU", "BDOU") 

length(c(unite4tb, crushtb, nc009, pantb))

# lesion_ranked_regimens_new_reg <- read.csv("~/Dropbox/SavicMisc/TBDA_2023_Oct/20240409_Lesion_ranked_regimens_with_Wave2023b.csv") %>%
#   rename(regimen_name = Regimen) %>% 
#   mutate(regimen_name = ifelse(regimen_name == "R40MHZ", "R1800MHZ", regimen_name)) %>% 
#   filter(regimen_name %notin% c("BPaMZ", "PaMZ", "HPZM", "HPZE", "HRZE", 
#                                 "HPZEC", "BPaL", "BPaLM", "BPaUG8", "R15HZ", "R20HZ", "R40HZ",
#                                 "R1200HZE", "R1800HZE", "RZME", "RZM")) %>% #rm dupplicates
#   filter(!grepl("G2", regimen_name)) %>% 
#   filter(!grepl("G8", regimen_name)) %>% 
#   mutate(Predictor = regimen_name) 

lesion_ranked_regimens_new_reg <- regimen_coverage_all %>% 
    rename(regimen_name = Regimen) %>% 
  mutate(regimen_name = ifelse(regimen_name == "R40MHZ", "R1800MHZ", regimen_name)) %>% 
  filter(regimen_name %notin% c("BPaMZ", "PaMZ", "HPZM", "HPZE", "HRZE", 
                                "HPZEC", "BPaL", "BPaLM", "BPaUG8", "R15HZ", "R20HZ", "R40HZ",
                                "R1200HZE", "R1800HZE", "RZME", "RZM", "HRZM")) %>% #rm dupplicates
  filter(!grepl("G2", regimen_name)) %>% 
  filter(!grepl("G8", regimen_name)) %>% 
  mutate(Predictor = regimen_name) %>% 
  mutate(Outcome = -1) %>% 
  bind_rows(., lesion_ranked_regimens ) %>% 
  filter(Outcome >= 0 | Predictor %in% c(unite4tb,crushtb,nc009,pantb)) %>%  # UNITE4TB
  mutate(Predictor = gsub('S8', 'TBAJ876', Predictor)) %>% 
  mutate(Predictor = gsub('S5_100_', 'TBAJ587_', Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "RZM | REMoxTB") %>% 
  filter(Predictor != "BLZ")

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_new_reg_by_N_drug_color_by_outcome.png'), units = "in",res = 300,
     height = 4.5, width = 6)


lesion_ranked_regimens_new_reg  %>% 
  arrange(hours_total, Outcome, desc(Predictor)) %>% 
  group_by(hours_total, Outcome) %>% 
  mutate(Predictor = ifelse(Predictor == "BDOU",  "BDQU", Predictor)) %>%  # replace O with Q
  mutate(Predictor = ifelse(Predictor == "BPaOU", "BPaQU", Predictor)) %>%  # replace O with Q
  mutate(Predictor = fct_reorder(Predictor, hours_total)) %>% 
  mutate(Predictor = factor(Predictor, levels = c(
    "HRZE | Standard-of-care",
    "R1200HZ | HIRIF/RIFASHORT",
    "R1800HZ | HIRIF/RIFASHORT",
    "BDZT",
    "BDZG6",
    "BDLT",
    "BDLG6",
    "BDG6T",
    "RZME | REMoxTB",
    "HRZM | REMoxTB",
    "HRZG | OFLOTUB",
    "HPZEC | CLO-FAST",
    "HPZE | S31/A5349",
    "BDQU",
    "TBAJ876_25_PaL",  
    "TBAJ876_50_PaL",
    "TBAJ876_100_PaL",
    "BMZT",
    "BMZD",
    "BDMT",
    "BDMG6",
    "BDM",
    "PaMZ | STAND",
    "HPZM | S31/A5349",
    "BPaL | Nix/ZeNix",          
    "BPaQU",                     
    "BPaMT",                    
    "BPaMG6",
    "BMZRb",
    "BPaMZ | Simplici-TB",
    "BPaLM | TB-PRACTECAL"  
  ))) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = hours_total/24, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = c("#008080","grey","#87AE73"))+
  guides(fill="none")+
  ylab("")+
  xlab("Number of drugs in the regimen\nthat meet the PK-PD target in caseum")+
  theme_bw()+
  annotate(geom = "text", label = "'Successful' regimen", color = "#87AE73", x = 3, y = "BDLT", hjust=1)+
  annotate(geom = "text", label = "'Unsuccessful' regimen", color = "grey", x = 3, y = "BDLG6", hjust=1)+
  annotate(geom = "text", label = "Predicted regimen", color = "#008080", x = 3, y = "BDG6T", hjust=1)+
  theme(axis.text = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()

regimen_rank_caseum<- lesion_ranked_regimens_new_reg %>% 
  arrange(-hours_total) %>% 
  mutate(CASEUM_RANK = dense_rank(desc(hours_total)))

clinical_outcome <- regimen_rank_caseum %>% select(regimen_name, Predictor, Outcome)

```

# RERUN WITH CELL
## Take all Cellular PK / macIC90 for all regimens in Ph3 trials
```{r}

sim_df <- simulation_collect_all_drugs %>% 
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH",DRUG )) %>% 
  mutate(SPECIES = ifelse(SPECIES == "Corrected \nRabbit", "Corrected Rabbit", SPECIES))

target_labels <- drug_potency_MRT2 %>% 
  select( DRUG, DRUG_name_long, LESIONNAME, MW, contains("mgL")) %>% 
  pivot_longer(cols = contains("mgL"), names_to = "LABEL", values_to = "TARGET") %>% 
  mutate(TARGET = ifelse(is.na(TARGET), 999, TARGET))

sim_df <- sim_df %>% left_join(., target_labels) %>% mutate(LESIONNAME = factor(LESIONNAME, levels = lesion_level))

sim_df %>% filter(LABEL == "MIC_mgL") %>% drop_na() %>% pull(DRUG) %>% unique()

coverage_all_drugs_REG_PLOTS <- sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>%
  filter(LESIONNAME %in% c("Cellular lesion")) %>% 
  filter(LABEL == "macIC90_mgL") %>% 
  filter(TIME<264+24) %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  group_by(ROW_ID) %>% 
  summarise(hours_total_per_ROW_ID = sum(coverage_above_MRT))

coverage_all_drugs_REG_PLOTS$ROW_ID



BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24")
HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24")
BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24")
BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24")
BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24")
RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24")
HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24")
R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24")


regimen_df_cell <- 
  
  bind_rows(
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaMZ | Simplici-TB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% PaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PaMZ | STAND"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PMZ | S31/A5349, with H"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZE | S31/A5349"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HRZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZE | Standard-of-care"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HPZEC) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZEC | CLO-FAST"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BLZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BLZ"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaL) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaL | Nix/ZeNix"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% BPaLM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaLM | TB-PRACTECAL"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% RZME) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZME | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% HRZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZM | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R15HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R15HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R20HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R20HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% R40HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID) +8) %>% # 8 placeholder. do sim for hi RIF 1800 mg? 
      mutate(Regimen = "R40HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS %>% 
      filter(ROW_ID %in% RZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZM | REMoxTB")
    

)

#write.csv(regimen_df, "~/Dropbox/SavicMisc/TBDA_2023_Oct/Lesion_ranked_regimens.csv", row.names = F)
```

### OPERATIONALIZE 
```{r}


regimens <- list(
  
  #known outcome
  BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24"),
  HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24"),
  BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24"),
  BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24"),
  RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24"),
  HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24"),
  HRZG  = c("RIF_600_mg_24","PZA_1500_mg_24","GTX_400_mg_24","INH_s_300_mg_24"),# MXF placeholder for GTX
  
  #RIFASHORT COMPARE WITH MOUSE REGIMEN
  R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24"),
  
  #RIFASHORT COMPARE WITH CLIN OUTCOME
  R1200HZE = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  R1800HZE = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  
  #novel regimens: Notes can't use Rb and G8 (Rb modeling not completed, G8 follower of GSK656- ok to use 656?)
  #G8 probably inactive (like 656)
  # BMZRb = 
  BMZ = c("BDQ_400_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  BPaUG8 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  BPaUG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BOUG2 = c("BDQ_400_mg_24", "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaOU = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BDOG2 = c("BDQ_400_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24"), #G2 inactive
  BDUG2 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BPaOG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24"), #G2 inactive
  BDOU = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  DBO  = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"),
  BDUG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  PaOUG2 = c("PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  DOUG2 = c("DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BDOG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"), #G8 probably inactive
  
  #other interesting regimens to predict:
  R40MHZ = c("RIF_1800_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  S8_100_PaOU = c("TBAJ-876_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_PaOU = c("TBAJ-587_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8_100_DOU = c("TBAJ-876_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_DOU = c("TBAJ-587_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  
  #wave 2023 part B
  S8_100_PaG6U = c("TBAJ-587_100_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G6 inactive
  S8_100_DG6U = c("TBAJ-587_100_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaG6U    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaUG8    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaG6G2   = c("BDQ_400_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24"),
  
  #CRUSH-TB
  BMZRb   = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "RBT_300_mg_24"),
  BMZD    = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "DLM_100_mg_12"), # add"DLM_300_mg_24"
  
  #CRUSH-TB potential wave 2
  S8ZMRb  = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "RBT_300_mg_24"),
  S8ZMD   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "DLM_100_mg_12"),
  S8ZMU   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMU  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMRb = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "RBT_300_mg_24"),
  # S8PaMA  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", ), #don't have A
  S8PaMO  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "OPC-167832_30_mg_24"),

  
  #UNITE4TB - PARADIGM4TB
  # A) HRZE/HR (Isoniazid + rifampicin + pyrazinamide + ethambutol for 8 weeks then isoniazid + rifampicin for 16 weeks)
  # B) BDM (Bedaquiline + delamanid + moxifloxacin)
  # C) BDMG6 (Bedaquiline + delamanid + moxifloxacin + GSK-656)
  # D) BDZG6 (Bedaquiline + delamanid + pyrazinamide + GSK-656)
  # E) BDLG6 Bedaquiline + delamanid + linezolid** + GSK-656
  # F) BPaMG6 (Bedaquiline + pretomanid + moxifloxacin + GSK-656)
  # G) BDMT (Bedaquiline + delamanid + moxifloxacin + BTZ-043)
  # H) BDZT (Bedaquiline + delamanid + pyrazinamide + BTZ-043)
  # I) BDLT (Bedaquiline + delamanid + linezolid** + BTZ-043)
  # J) BPaMT (Bedaquiline + pretomanid + moxifloxacin + BTZ-043)
  # K) BMZT (Bedaquiline + moxifloxacin + pyrazinamide + BTZ-043)
  # L) BDG6T (Bedaquiline + delamanid + GSK-656 + BTZ-043***)
  BDM     = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24"),
  BDMG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDZG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "GSK-656_20_mg_24"),
  BDLG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "GSK-656_20_mg_24"),
  BPaMG6  = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDMT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BDZT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDLT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "BTZ-043_1250_mg_24"),
  BPaMT   = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BMZT    = c("BDQ_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDG6T   = c("BDQ_200_mg_24", "DLM_100_mg_12", "GSK-656_20_mg_24", "BTZ-043_1250_mg_24")
  
  
  
  
  
  

)


# Create a df with hours_total for each regimen (hours_total = total hours above casMBC50 in caseum)
regimen_coverage_all_cell <- NULL

for (i in 1:length(regimens)) {
  
  regimen_coverage_all_cell <- bind_rows(regimen_coverage_all_cell,
                                    coverage_all_drugs_REG_PLOTS %>% 
                                      filter(ROW_ID %in% regimens[[i]] %>% unlist()) %>%
                                      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
                                      mutate(Regimen = names(regimens)[i])
  )
  
}


```

## Number of drugs in cell

```{r}

# lesion_ranked_regimens <- read.csv("~/Dropbox/SavicMisc/TBDA_2023_Oct/Lesion_ranked_regimens.csv") %>%
#   rename(Predictor = Regimen) %>% 
#   mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor))

lesion_ranked_regimens <- regimen_df_cell %>%
  rename(Predictor = Regimen) %>% 
  mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor)) %>% 
  left_join(., clinical_regimen_outcome)

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_by_N_drug_color_by_outcome_CELL'), units = "in",res = 300,
     height = 2.5, width = 6)

lesion_ranked_regimens %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "BLZ") %>% 
  mutate(Predictor = fct_reorder(Predictor, hours_total)) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = hours_total/24, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = c("#87AE73", "grey"))+
  guides(fill="none")+
  ylab("")+
  xlab("Lesion coverage\n(Number of drugs in cellular lesion)")+
  theme_bw()+
  theme(axis.text.y = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()



```

```{r}

lesion_ranked_regimens_new_reg <- regimen_coverage_all_cell %>% 
    rename(regimen_name = Regimen) %>% 
  mutate(regimen_name = ifelse(regimen_name == "R40MHZ", "R1800MHZ", regimen_name)) %>% 
  filter(regimen_name %notin% c("BPaMZ", "PaMZ", "HPZM", "HPZE", "HRZE", 
                                "HPZEC", "BPaL", "BPaLM", "BPaUG8", "R15HZ", "R20HZ", "R40HZ",
                                "R1200HZE", "R1800HZE", "RZME", "RZM", "HRZM")) %>% #rm dupplicates
  filter(!grepl("G2", regimen_name)) %>% 
  filter(!grepl("G8", regimen_name)) %>% 
  mutate(regimen_name = gsub('S8_100_', 'TBAJ876_', regimen_name)) %>% 
  mutate(regimen_name = gsub('S5_100_', 'TBAJ587_', regimen_name)) %>% 
  mutate(Predictor = regimen_name) %>% 
  mutate(Outcome = -1) %>% 
  bind_rows(., lesion_ranked_regimens) %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "BLZ")

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_new_reg_by_N_drug_color_by_outcome_CELL'), units = "in",res = 300,
     height = 4.5, width = 6)


lesion_ranked_regimens_new_reg %>% 
  arrange(hours_total, Outcome, desc(Predictor)) %>% 
  group_by(hours_total, Outcome) %>% 
  mutate(Predictor = fct_reorder(Predictor, hours_total)) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = hours_total/24, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = c("#008080","grey","#87AE73"))+
  guides(fill="none")+
  ylab("")+
  xlab("Number of drugs in the regimen\nthat meet the PK-PD target in caseum")+
  theme_bw()+
  theme(axis.text = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()

regimen_rank_cellular <- lesion_ranked_regimens_new_reg %>% 
  arrange(-hours_total) %>% 
  rename(hours_total_cell = hours_total) %>% 
  select(-Outcome) %>% 
  left_join(., clinical_outcome) %>% 
  mutate(CELLULAR_RANK = dense_rank(desc(hours_total_cell))) 

```

# RERUN WITH PLASMA
## Take all Plasma PK / MIC for all regimens in Ph3 trials
```{r}

sim_df <- simulation_collect_all_drugs %>% 
  mutate(DRUG = ifelse(DRUG == "INH_s", "INH",DRUG )) %>% 
  mutate(SPECIES = ifelse(SPECIES == "Corrected \nRabbit", "Corrected Rabbit", SPECIES))

target_labels <- drug_potency_MRT2 %>% 
  select( DRUG, DRUG_name_long, LESIONNAME, MW, contains("mgL")) %>% 
  pivot_longer(cols = contains("mgL"), names_to = "LABEL", values_to = "TARGET") %>% 
  mutate(TARGET = ifelse(is.na(TARGET), 999, TARGET))

sim_df <- sim_df %>% left_join(., target_labels) %>% mutate(LESIONNAME = factor(LESIONNAME, levels = lesion_level))

sim_df %>% filter(LABEL == "MIC_mgL") %>% drop_na() %>% pull(DRUG) %>% unique()

coverage_all_drugs_REG_PLOTS_plasma <- sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>% # because plasma not affected by species (it's all human)
  filter(LESIONNAME %in% c("Plasma")) %>% 
  filter(LABEL == "MIC_mgL") %>% 
  filter(TIME<264+24) %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  group_by(ROW_ID) %>% 
  summarise(hours_total_per_ROW_ID = sum(coverage_above_MRT))

BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24")
HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24")
HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24")
HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24")
BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24")
BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24")
BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24")
RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24")
HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24")
R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24")
RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24")


regimen_df_plasma <- 
  
  bind_rows(
    coverage_all_drugs_REG_PLOTS_plasma %>% 
      filter(ROW_ID %in% BPaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaMZ | Simplici-TB"),
    
    coverage_all_drugs_REG_PLOTS_plasma %>% 
      filter(ROW_ID %in% PaMZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PaMZ | STAND"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% HPZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "PMZ | S31/A5349, with H"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% HPZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZE | S31/A5349"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% HRZE) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZE | Standard-of-care"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% HPZEC) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HPZEC | CLO-FAST"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% BLZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BLZ"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% BPaL) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaL | Nix/ZeNix"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% BPaLM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "BPaLM | TB-PRACTECAL"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% RZME) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZME | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% HRZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "HRZM | REMoxTB"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% R15HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R15HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% R20HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "R20HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% R40HZ) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID) +8) %>% # 8 placeholder. do sim for hi RIF 1800 mg? 
      mutate(Regimen = "R40HZ | HIRIF/RIFASHORT"),
    
    coverage_all_drugs_REG_PLOTS_plasma  %>% 
      filter(ROW_ID %in% RZM) %>%
      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
      mutate(Regimen = "RZM | REMoxTB")
    

)


```

### OPERATIONALIZE 
```{r}


regimens <- list(
  
  #known outcome
  BPaMZ = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  PaMZ  = c("PMD_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  HPZM  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "MXF_400_mg_24"),
  HPZE  = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HRZE  = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24"),
  HPZEC = c("RPT_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24", "EMB_1200_mg_24", "CFZ_100_mg_24"),
  BLZ   = c("BDQ_400_mg_24", "LZD_600_mg_24", "PZA_1500_mg_24"),
  BPaL  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24"),
  BPaLM  = c("BDQ_400_mg_24", "PMD_200_mg_24", "LZD_600_mg_24","MXF_400_mg_24"),
  RZME  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","EMB_1200_mg_24"),
  HRZM  = c("RIF_600_mg_24","PZA_1500_mg_24","MXF_400_mg_24","INH_s_300_mg_24"),
  HRZG  = c("RIF_600_mg_24","PZA_1500_mg_24","GTX_400_mg_24","INH_s_300_mg_24"),# MXF placeholder for GTX
  
  #RIFASHORT COMPARE WITH MOUSE REGIMEN
  R15HZ = c("RIF_600_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R20HZ = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  R40HZ = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  RZM   = c("RIF_600_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24"),
  
  #RIFASHORT COMPARE WITH CLIN OUTCOME
  R1200HZE = c("RIF_1200_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  R1800HZE = c("RIF_1800_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24","EMB_1200_mg_24"),
  
  #novel regimens: Notes can't use Rb and G8 (Rb modeling not completed, G8 follower of GSK656- ok to use 656?)
  #G8 probably inactive (like 656)
  # BMZRb = 
  BMZ = c("BDQ_400_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24"),
  BPaUG8 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  BPaUG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BOUG2 = c("BDQ_400_mg_24", "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaOU = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BDOG2 = c("BDQ_400_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24"), #G2 inactive
  BDUG2 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),#G2 inactive
  BPaOG2 = c("BDQ_400_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24"), #G2 inactive
  BDOU = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  DBO  = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"),
  BDUG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), # G8 probably inactive
  PaOUG2 = c("PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  DOUG2 = c("DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BDOG8 = c("BDQ_400_mg_24", "DLM_100_mg_12",  "OPC-167832_30_mg_24"), #G8 probably inactive
  
  #other interesting regimens to predict:
  R40MHZ = c("RIF_1800_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "INH_s_300_mg_24"),
  S8_100_PaOU = c("TBAJ-876_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_PaOU = c("TBAJ-587_100_mg_24", "PMD_200_mg_24", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8_100_DOU = c("TBAJ-876_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S5_100_DOU = c("TBAJ-587_100_mg_24", "DLM_100_mg_12", "OPC-167832_30_mg_24",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  
  #wave 2023 part B
  S8_100_PaG6U = c("TBAJ-587_100_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G6 inactive
  S8_100_DG6U = c("TBAJ-587_100_mg_24", "DLM_100_mg_12",  "SZD_1200_mg_24", "SZD-M1_1200_mg_24"), #G2 inactive
  BPaG6U    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaUG8    = c("BDQ_400_mg_24", "PMD_200_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  BPaG6G2   = c("BDQ_400_mg_24", "PMD_200_mg_24","GSK-656_20_mg_24"),
  
  #CRUSH-TB
  BMZRb   = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "RBT_300_mg_24"),
  BMZD    = c("BDQ_200_mg_24", "MXF_400_mg_24",  "PZA_1500_mg_24", "DLM_100_mg_12"), # add"DLM_300_mg_24"
  
  #CRUSH-TB potential wave 2
  S8ZMRb  = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "RBT_300_mg_24"),
  S8ZMD   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "DLM_100_mg_12"),
  S8ZMU   = c("TBAJ-876_100_mg_24", "PZA_1500_mg_24", "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMU  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "SZD_1200_mg_24", "SZD-M1_1200_mg_24"),
  S8PaMRb = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "RBT_300_mg_24"),
  # S8PaMA  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", ), #don't have A
  S8PaMO  = c("TBAJ-876_100_mg_24", "PMD_200_mg_24",  "MXF_400_mg_24", "OPC-167832_30_mg_24"),

  
  #UNITE4TB - PARADIGM4TB
  # A) HRZE/HR (Isoniazid + rifampicin + pyrazinamide + ethambutol for 8 weeks then isoniazid + rifampicin for 16 weeks)
  # B) BDM (Bedaquiline + delamanid + moxifloxacin)
  # C) BDMG6 (Bedaquiline + delamanid + moxifloxacin + GSK-656)
  # D) BDZG6 (Bedaquiline + delamanid + pyrazinamide + GSK-656)
  # E) BDLG6 Bedaquiline + delamanid + linezolid** + GSK-656
  # F) BPaMG6 (Bedaquiline + pretomanid + moxifloxacin + GSK-656)
  # G) BDMT (Bedaquiline + delamanid + moxifloxacin + BTZ-043)
  # H) BDZT (Bedaquiline + delamanid + pyrazinamide + BTZ-043)
  # I) BDLT (Bedaquiline + delamanid + linezolid** + BTZ-043)
  # J) BPaMT (Bedaquiline + pretomanid + moxifloxacin + BTZ-043)
  # K) BMZT (Bedaquiline + moxifloxacin + pyrazinamide + BTZ-043)
  # L) BDG6T (Bedaquiline + delamanid + GSK-656 + BTZ-043***)
  BDM     = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24"),
  BDMG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDZG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "GSK-656_20_mg_24"),
  BDLG6   = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "GSK-656_20_mg_24"),
  BPaMG6  = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "GSK-656_20_mg_24"),
  BDMT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BDZT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDLT    = c("BDQ_200_mg_24", "DLM_100_mg_12", "LZD_600_mg_24", "BTZ-043_1250_mg_24"),
  BPaMT   = c("BDQ_400_mg_24", "PMD_200_mg_24", "MXF_400_mg_24", "BTZ-043_1250_mg_24"),
  BMZT    = c("BDQ_200_mg_24", "MXF_400_mg_24", "PZA_1500_mg_24", "BTZ-043_1250_mg_24"),
  BDG6T   = c("BDQ_200_mg_24", "DLM_100_mg_12", "GSK-656_20_mg_24", "BTZ-043_1250_mg_24")
  
  
  
  
  
  

)


# Create a df with hours_total for each regimen (hours_total = total hours above casMBC50 in caseum)
regimen_coverage_all_plasma <- NULL

for (i in 1:length(regimens)) {
  
  regimen_coverage_all_plasma <- bind_rows(regimen_coverage_all_plasma,
                                    coverage_all_drugs_REG_PLOTS_plasma %>% 
                                      filter(ROW_ID %in% regimens[[i]] %>% unlist()) %>%
                                      summarise(hours_total = sum(hours_total_per_ROW_ID)) %>% 
                                      mutate(Regimen = names(regimens)[i])
  )
  
}


```

## Number of drugs in plasma

```{r}

# lesion_ranked_regimens <- read.csv("~/Dropbox/SavicMisc/TBDA_2023_Oct/Lesion_ranked_regimens.csv") %>%
#   rename(Predictor = Regimen) %>% 
#   mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor))

lesion_ranked_regimens <- regimen_df_plasma %>%
  rename(Predictor = Regimen) %>% 
  mutate(Predictor = ifelse(Predictor == "PMZ | S31/A5349, with H", "HPZM | S31/A5349", Predictor)) %>% 
  left_join(., clinical_regimen_outcome)

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_by_N_drug_color_by_outcome_plasma'), units = "in",res = 300,
     height = 2.5, width = 6)

lesion_ranked_regimens %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "BLZ") %>% 
  mutate(Predictor = fct_reorder(Predictor, hours_total)) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = hours_total/24, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = rev(c("#87AE73", "grey")))+
  guides(fill="none")+
  ylab("")+
  xlab("Lesion coverage\n(Number of drugs in plasma)")+
  theme_bw()+
  theme(axis.text.y = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()



```

```{r}

lesion_ranked_regimens_new_reg <- regimen_coverage_all_plasma %>% 
    rename(regimen_name = Regimen) %>% 
  mutate(regimen_name = ifelse(regimen_name == "R40MHZ", "R1800MHZ", regimen_name)) %>% 
  filter(regimen_name %notin% c("BPaMZ", "PaMZ", "HPZM", "HPZE", "HRZE", 
                                "HPZEC", "BPaL", "BPaLM", "BPaUG8", "R15HZ", "R20HZ", "R40HZ",
                                "R1200HZE", "R1800HZE", "RZME", "RZM", "HRZM")) %>% #rm dupplicates
  filter(!grepl("G2", regimen_name)) %>% 
  filter(!grepl("G8", regimen_name)) %>% 
  mutate(regimen_name = gsub('S8_100_', 'TBAJ876_', regimen_name)) %>% 
  mutate(regimen_name = gsub('S5_100_', 'TBAJ587_', regimen_name)) %>% 
  mutate(Predictor = regimen_name) %>% 
  mutate(Outcome = -1) %>% 
  bind_rows(., lesion_ranked_regimens) %>% 
  mutate(Predictor = ifelse(Predictor == "R20HZ | HIRIF/RIFASHORT", 
                            "R1200HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  mutate(Predictor = ifelse(Predictor == "R40HZ | HIRIF/RIFASHORT", 
                            "R1800HZ | HIRIF/RIFASHORT", Predictor)) %>% 
  filter(Predictor != "R15HZ | HIRIF/RIFASHORT") %>% 
  filter(Predictor != "BLZ")

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Lesion_coverage_new_reg_by_N_drug_color_by_outcome_plasma'), units = "in",res = 300,
     height = 4.5, width = 6)


lesion_ranked_regimens_new_reg %>% 
  arrange(hours_total, Outcome, desc(Predictor)) %>% 
  group_by(hours_total, Outcome) %>% 
  mutate(Predictor = fct_reorder(Predictor, hours_total)) %>% 
  ggplot(lesion_ranked_regimens, mapping = aes(x = hours_total/24, y = Predictor, fill=factor(Outcome)))+
  geom_col()+
  scale_fill_manual(values = c("#008080","grey","#87AE73"))+
  guides(fill="none")+
  ylab("")+
  xlab("Number of drugs in the regimen\nthat meet the PK-PD target in plasma")+
  labs(caption = "Some regimens have more drugs than drugs in regimen due to active metabolite")+
  theme_bw()+
  theme(axis.text = element_text(size=8),
        axis.title.x = element_text(size=8),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

dev.off()

regimen_rank_cellular <- lesion_ranked_regimens_new_reg %>% 
  arrange(-hours_total) %>% 
  rename(hours_total_cell = hours_total) %>% 
  select(-Outcome) %>% 
  left_join(., clinical_outcome) %>% 
  mutate(CELLULAR_RANK = dense_rank(desc(hours_total_cell))) 

```

# RANKING PLOT CELL VERSUS CASEUM

```{r}

ranking_df <- left_join(regimen_rank_caseum %>% select(-regimen_name), 
                        regimen_rank_cellular %>% select(-regimen_name))

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Rank_by_caseum_v_cell_all_regimens'), units = "in",res = 300,
     height = 6, width = 9)

ranking_df %>%
  mutate(regimen_name = Predictor) %>% 
  mutate(CASEUM_RANK= as.numeric(as.character(CASEUM_RANK))) %>% 
  mutate(CELLULAR_RANK= as.numeric(as.character(CELLULAR_RANK))) %>% 
  group_by(hours_total, Outcome) %>% 
  mutate(regimen_name = fct_reorder(regimen_name, -CASEUM_RANK)) %>% 
  ggplot(aes(x = CASEUM_RANK, y = regimen_name, label = CASEUM_RANK))+
  
  geom_segment(aes(x = CELLULAR_RANK, xend = CASEUM_RANK, y = regimen_name, yend = regimen_name))+
  
  # CELLULAR
  geom_point(aes(x = CELLULAR_RANK, y = regimen_name), shape = 21, size = 7, fill = "white")+
  geom_text(aes(x = CELLULAR_RANK, y = regimen_name, label = CELLULAR_RANK), fontface="bold")+
  
  # CASEUM
  geom_point(size = 7)+
  geom_text(color="white", fontface="bold")+
  
  # # LEGEND
  # annotate(geom="label", label = "Cellular PKPD", size = 3,
  #          x = 13, y = "S8PaMRb", hjust = 1)+
  # annotate(geom="label", label = "Caseum PKPD", size = 3,
  #          x = 13,   y = "S8PaMRb", hjust = 1, vjust = 1.8, fill = "black", color = "white")+
  
  # LEGEND - UNITE4TB
  annotate(geom="label", label = "Cellular PKPD", size = 3,
           x = 13, y = "BPaMZ | Simplici-TB", hjust = 1)+
  annotate(geom="label", label = "Caseum PKPD", size = 3,
           x = 13,   y = "BPaMZ | Simplici-TB", hjust = 1, vjust = 1.8, fill = "black", color = "white")+
  
  xlab("Rank")+
  ylab("")+
  scale_x_continuous(breaks = seq(0,20,1))+
  theme(panel.grid = element_blank())

dev.off()

```


### Without predicted regimens
```{r}

png(paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d") ,'Rank_by_caseum_v_cell_observed_regimens'), units = "in",res = 300,
     height = 4, width = 6)

ranking_df <- left_join(regimen_rank_caseum %>% select(-regimen_name), 
                        regimen_rank_cellular %>% select(-regimen_name)) %>% 
  filter(Outcome != -1) %>% 
  mutate(CELLULAR_RANK = dense_rank(desc(hours_total_cell))) %>% 
  mutate(CASEUM_RANK = dense_rank(desc(hours_total))) 
  

ranking_df %>%
  mutate(regimen_name = Predictor) %>% 
  mutate(CASEUM_RANK= as.numeric(as.character(CASEUM_RANK))) %>% 
  mutate(CELLULAR_RANK= as.numeric(as.character(CELLULAR_RANK))) %>% 
  group_by(hours_total, Outcome) %>% 
  mutate(regimen_name = fct_reorder(regimen_name, -CASEUM_RANK)) %>% 
  ggplot(aes(x = CASEUM_RANK, y = regimen_name, label = CASEUM_RANK))+
  
  geom_segment(aes(x = CELLULAR_RANK, xend = CASEUM_RANK, y = regimen_name, yend = regimen_name))+
  
  # CELLULAR
  geom_point(aes(x = CELLULAR_RANK, y = regimen_name), shape = 21, size = 7, fill = "white")+
  geom_text(aes(x = CELLULAR_RANK, y = regimen_name, label = CELLULAR_RANK), fontface="bold")+
  
  # CASEUM
  geom_point(size = 7)+
  geom_text(color="white", fontface="bold")+
  
  # LEGEND
  annotate(geom="label", label = "Cellular PKPD", size = 3,
           x = 10, y = "BPaMZ | Simplici-TB", hjust = 1)+
  annotate(geom="label", label = "Caseum PKPD", size = 3,
           x = 10,   y = "BPaMZ | Simplici-TB", hjust = 1, vjust = 1.8, fill = "black", color = "white")+
  
  xlab("Rank")+
  ylab("")+
  scale_x_continuous(breaks = seq(0,20,1))+
  theme(panel.grid = element_blank())

dev.off()

```



# Easy versus hard to treat
```{r}

# for loop for plotting coverage easy v hard to treat per regimen


cov_plots <- lapply(names(regimens), function(reg){
  
  p <- coverage_all_drugs %>%
    filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
    mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>% 
    mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>% 
    mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>% 
    filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>% 
    ggplot(mapping = aes(x = TAD-0.5, y = DRUG, fill = LESIONNAME))+
    geom_point(shape = 22, size = 4, stroke = 0.2)+
    facet_wrap(~LESIONNAME, ncol = 1)+
    scale_y_discrete(expand = expansion(add = c(1, 1.5)))+
    scale_x_continuous(breaks = seq(0,24,4), limits = c(0, 24))+
    scale_fill_manual(values = c("#0072B2","#D55E00"))+
    labs(x = "",
         y = "",
         caption = "",
         title = reg)+
    theme_bw(base_size = 10)+
    theme(legend.position = "none",
          strip.background = element_rect(fill = "transparent"),
          panel.grid = element_blank(),
          plot.title = element_text(size = 12, hjust=0.5))
  
  
  h <- if(length(regimens[[reg]]) == 4) { 
      
    3.8 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    3.4 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    4.2
    
    }
  
  w <- if(!grepl("O", reg) & !grepl("U", reg)) {
    
    3.8
    
  } else if(grepl("O", reg)) { #contains OPC
    
    3.8+0.7
    
  } else { #contains U (and OPC)
    
    3.8+0.2
    
  }
  
  ggsave(p, file = paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d"), "_", reg, "_coverage_easyvhard.png"),
         width = w, height = h)
})

```

# Version 2
```{r}

# for loop for plotting coverage easy v hard to treat per regimen
totals_for_levels_df <- coverage_all_drugs_intermediate %>%
  ## use MXF as a placeholder for GTX in HRZG
    bind_rows(., coverage_all_drugs_intermediate %>% filter(DRUG == "MXF") %>% mutate(DRUG = "GTX")) %>% 
    ##
                                 mutate(II_num = ifelse(II == "BID", 12, 24)) %>%
                         mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>%
                          mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>%
                          filter(LESIONNAME %in% c("Caseum")) %>%
                         # mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>%
                          select(DRUG, NEW_ROW_ID,coverage_above_MRT) %>% 
                           group_by(DRUG, NEW_ROW_ID) %>%
                          summarise(count = sum(coverage_above_MRT)) %>% 
                          ungroup() %>% 
                          mutate(NEW_ROW_ID = fct_reorder(NEW_ROW_ID, count))

cov_plots <- lapply(names(regimens), function(reg){
  
  
    pad_factor <- if(length(regimens[[reg]]) == 4) { 
      
    0.8 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    1.6 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2.4
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    0.3
    
    }
  
  
  
  p <- coverage_all_drugs %>%
    
    ## use MXF as a placeholder for GTX in HRZG
    bind_rows(., coverage_all_drugs %>% filter(DRUG == "MXF") %>% mutate(DRUG = "GTX")) %>% 
    ##
    
    filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
    mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>% 
    mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>% 
    mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>% 
    filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>% 
    
    left_join(., totals_for_levels_df %>% filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist())) %>% 
    mutate(DRUG = fct_reorder(DRUG, count)) %>% 
    mutate(ncount = as.factor(count)) %>% 
    mutate(ncount = fct_reorder(ncount, count)) %>%
    

    
    ggplot(mapping = aes(x = TAD-0.5, y = reorder(DRUG, count, decreasing = T), fill = LESIONNAME))+
    geom_point(shape = 22, size = 4, stroke = 0.2)+
    facet_wrap(~LESIONNAME, ncol = 1)+
    scale_y_discrete(expand = expansion(c(0.3, pad_factor)))+
    scale_x_continuous(breaks = seq(0,24,12), limits = c(0, 24))+
    scale_fill_manual(values = c("#0072B2","#D55E00"))+
    labs(x = "",
         y = "",
         caption = "",
         title = reg)+
    theme_bw(base_size = 13)+
    theme(axis.text = element_text(size=17),
          legend.position = "none",
          strip.background = element_blank(),
          strip.text = element_blank(),
          panel.grid = element_blank(),
            axis.line = element_blank(),
            panel.grid.major = element_line(colour="white"),
            panel.grid.minor = element_line(colour="white"),
            panel.background = element_blank(),
          plot.title = element_text(size = 12, hjust=0.5))
  
  p
  h <- if(length(regimens[[reg]]) == 4) { 
      
    4 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    3.4 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    4.9
    
    }
  
  w <- if(!grepl("O", reg) & !grepl("U", reg)) {
    
    3.8
    
  } else if(grepl("O", reg)) { #contains OPC
    
    3.8+0.45
    
  } else { #contains U (and OPC)
    
    3.8+0.2
    
  }
  
  ggsave(p, file = paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d"), "_", reg, "_coverage_easyvhard_v2.png"),
         width = w, height = 4)
})

```

# Version 2 - ETT is Cell/macIC90, HTT is Cas/casMBC50
```{r}

# for loop for plotting coverage easy v hard to treat per regimen
totals_for_levels_df <- coverage_all_drugs_intermediate %>%
                         mutate(II_num = ifelse(II == "BID", 12, 24)) %>%
                         mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>%
                         mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>%
                         filter(LESIONNAME %in% c("Cellular lesion", "Caseum")) %>%
                         # mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>%
                         select(DRUG, NEW_ROW_ID,coverage_above_MRT) %>% 
                         group_by(DRUG, NEW_ROW_ID) %>%
                         summarise(count = sum(coverage_above_MRT)) %>% 
                         ungroup() %>% 
                         mutate(NEW_ROW_ID = fct_reorder(NEW_ROW_ID, count))

# for drugs that have no coverage, keep their label on the plot     
df_placeholder <- cross_join(coverage_all_drugs %>% distinct(DRUG, DOSE, II_num),
           tibble(LESIONNAME = c("Cellular lesion", "Caseum"))) %>% mutate(TAD = -99, coverage_above_MRT = 1)
  

cov_plots <- lapply(names(regimens), function(reg){
  
  
    pad_factor <- if(length(regimens[[reg]]) == 4) { 
      
    0.8 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    1.6 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2.4
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    0.3
    
    }
 

  p <- coverage_all_drugs %>%
    
    bind_rows(., df_placeholder) %>% 
    filter(LESIONNAME %in% c("Cellular lesion", "Caseum")) %>% 
    mutate(LESIONNAME = ifelse(LESIONNAME == "Cellular lesion", "Easy-to-treat", "Hard-to-treat")) %>% 
    mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>% 
    mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>% 
    filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>% 
    
    left_join(., totals_for_levels_df %>% filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist())) %>% 
    mutate(DRUG = fct_reorder(DRUG, count)) %>% 
    mutate(ncount = as.factor(count)) %>% 
    mutate(ncount = fct_reorder(ncount, count)) %>%
    

    
    ggplot(mapping = aes(x = TAD-0.5, y = reorder(DRUG, count, decreasing = T), fill = LESIONNAME))+
    geom_point(shape = 22, size = 4, stroke = 0.2)+
    facet_wrap(~LESIONNAME, ncol = 1)+
    scale_y_discrete(expand = expansion(c(0.3, pad_factor)))+
    scale_x_continuous(breaks = seq(0,24,12), limits = c(0, 24))+
    scale_fill_manual(values = c("#0072B2","#D55E00"))+
    labs(x = "",
         y = "",
         caption = "",
         title = reg)+
    theme_bw(base_size = 13)+
    theme(axis.text = element_text(size=17),
          legend.position = "none",
          strip.background = element_blank(),
          strip.text = element_blank(),
          panel.grid = element_blank(),
            axis.line = element_blank(),
            panel.grid.major = element_line(colour="white"),
            panel.grid.minor = element_line(colour="white"),
            panel.background = element_blank(),
          plot.title = element_text(size = 12, hjust=0.5))
  
  p
  h <- if(length(regimens[[reg]]) == 4) { 
      
    4 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    3.4 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    4.9
    
    }
  
  w <- if(!grepl("O", reg) & !grepl("U", reg)) {
    
    3.8
    
  } else if(grepl("O", reg)) { #contains OPC
    
    3.8+0.45
    
  } else { #contains U (and OPC)
    
    3.8+0.2
    
  }
  
  print(regimens[[reg]])
  
  ggsave(p, file = paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d"), "_", reg, "_coverage_easyvhard_v2_cell.png"),
         width = w, height = 4)
})

```

# Version 3
```{r}

# for loop for plotting coverage easy v hard to treat per regimen




cov_plots <- lapply(names(regimens), function(reg){
  
  
  # blanks <- cross_join(sim_df %>% 
  #                        mutate(II_num = ifelse(II == "BID", 12, 24)) %>% 
  #                        mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>% 
  #                         mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>% 
  #                         filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>% 
  #                        select(DRUG,NEW_ROW_ID) %>% unique(),
  #                    expand_grid(TAD = seq(0,24),
  #                                LESIONNAME = factor(c("Easy-to-treat", "Hard-to-treat"),
  #                                                    levels = c("Easy-to-treat", "Hard-to-treat")))) %>% 
  #   left_join(., tibble(coverage_all_drugs %>%
  #                         filter(LESIONNAME %in% c("Plasma", "Caseum")) %>%
  #                         mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>%
  #                         group_by(DRUG, LESIONNAME) %>%
  #                         summarise(count = n()+sum(coverage_above_MRT))))  %>%
  #   mutate(count = ifelse(is.na(count), 0, count)) %>% 
  #   group_by(LESIONNAME) %>%
  #   mutate(DRUG = ifelse(LESIONNAME == "Easy-to-treat", paste(".",DRUG), DRUG)) %>% 
  #   mutate(DRUG = fct_reorder(DRUG, count)) %>% 
  #   mutate(dummy = ifelse(LESIONNAME == "Easy-to-treat", ".", ","))
  
  blanks <- cross_join(sim_df %>%
                         mutate(II_num = ifelse(II == "BID", 12, 24)) %>%
                         mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>%
                          mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>%
                          filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>%
                         select(DRUG,NEW_ROW_ID) %>% unique() %>% 
                         mutate(TAD = 0),
                       tibble(LESIONNAME = c("Easy-to-treat", "Hard-to-treat"))) %>% 
    left_join(., totals_for_levels_df) %>% 
    mutate(count = ifelse(is.na(count), 0, count)) %>% 
    group_by(LESIONNAME) %>% 
    mutate(DRUG = fct_reorder(DRUG, count))
  
  p <- coverage_all_drugs %>%
    filter(LESIONNAME %in% c("Plasma", "Caseum")) %>% 
    mutate(LESIONNAME = ifelse(LESIONNAME == "Plasma", "Easy-to-treat", "Hard-to-treat")) %>% 
    mutate(NEW_ROW_ID = paste(DRUG, DOSE, "mg", II_num, sep = "_")) %>% 
    mutate(NEW_ROW_ID = ifelse(DRUG == "INH", paste(DRUG,"s", DOSE, "mg", II_num, sep = "_"), NEW_ROW_ID)) %>% 
    filter(NEW_ROW_ID %in% regimens[[reg]] %>% unlist()) %>% 
    
    left_join(., totals_for_levels_df) %>% 
    mutate(count = ifelse(is.na(count), 0, count)) %>% 
    group_by(LESIONNAME) %>% 
    mutate(DRUG = fct_reorder(DRUG, count)) %>% 
    
    mutate(dummy = ifelse(LESIONNAME == "Easy-to-treat", ".", ",")) %>% 
    #interaction(dummy, DRUG)
    ggplot(mapping = aes(x = TAD-0.5, y = DRUG, fill = LESIONNAME))+
    geom_point(shape = 22, size = 4, stroke = 0.2)+
    geom_point(blanks , 
               mapping = aes(x = TAD-0.5, y = DRUG), fill = "transparent", color = "transparent",
               shape = 22, size = 4, stroke = 0.2, inherit.aes = F)+
    #facet_wrap(~LESIONNAME, ncol = 1)+
    scale_y_discrete(expand = expansion(add = c(1, 1.5)))+
    scale_x_continuous(breaks = seq(0,24,4), limits = c(0, 24))+
    scale_fill_manual(values = c("#0072B2","#D55E00","transparent"))+
    labs(x = "",
         y = "",
         caption = "",
         title = reg)+
    theme_bw(base_size = 10)+
    theme(legend.position = "none",
          strip.background = element_rect(fill = "transparent"),
          panel.grid = element_blank(),
          plot.title = element_text(size = 12, hjust=0.5))
  
  
  h <- if(length(regimens[[reg]]) == 4) { 
      
    3.8 
    
    } else if(length(regimens[[reg]]) == 3)  { 
      
    3.4 
    
    } else if(length(regimens[[reg]]) == 2)  { 
      
    2
    
    } else if(length(regimens[[reg]]) == 5)  { 
      
    4.2
    
    }
  
  w <- if(!grepl("O", reg) & !grepl("U", reg)) {
    
    3.8
    
  } else if(grepl("O", reg)) { #contains OPC
    
    3.8+0.7
    
  } else { #contains U (and OPC)
    
    3.8+0.2
    
  }
  
  ggsave(p, file = paste0(WD, wd_fig, format(Sys.Date(), "%Y%m%d"), "_", reg, "_coverage_easyvhard_v3.png"),
         width = w, height = h)
})

```



#TBAJ-876 + PaL (100 mg)

```{r}
## TBAJ-876 - PaL ####
tbaj876pal <- tibble(DRUG = c("TBAJ-876", "PMD",  "LZD"),
               DRUG_num = c(3,2,1))

sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>% 
  mutate(TARGET = ifelse(DRUG=="SZD-M1", 29.6, TARGET)) %>% # Ex_Vivo_Caseum_Assay.Rmd (20230726_conc-response_FIXGAMMA_log10)
  mutate(TARGET = ifelse(DRUG=="EMB", 100, TARGET)) %>% # add targets for those that are NA
  # mutate(MRT = case_when(LESIONNAME == "Plasma" ~ MIC_mgL,
  #                      LESIONNAME == "Lung" ~ macIC90_mgL,
  #                      LESIONNAME == "Cellular lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Cavity wall" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseous lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseum" ~ casMBC50_mgL)) %>% 
  filter(ROW_ID %in% c("TBAJ-876_100_mg_24", "PMD_200_mg_24", "LZD_600_mg_24") ) %>% 
  filter(LESIONNAME == "Plasma" & LABEL == "MIC_mgL" |
           LESIONNAME == "Caseum" & LABEL == "casMBC50_mgL_char_7") %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., tbaj876pal) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "TBAJ-876 (100 mg) + PaL")+
  theme(strip.background = element_blank(),
        legend.position = "none",
        title = element_text(size = 10))+
  scale_fill_manual(values=c("white","royalblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_TBAJ876PaL_CorrectedRabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)
```

#TBAJ-876 + PaL (50 mg)

```{r}
## TBAJ-876 - PaL ####
tbaj876pal <- tibble(DRUG = c("TBAJ-876", "PMD",  "LZD"),
               DRUG_num = c(3,2,1))

sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>% 
  mutate(TARGET = ifelse(DRUG=="SZD-M1", 29.6, TARGET)) %>% # Ex_Vivo_Caseum_Assay.Rmd (20230726_conc-response_FIXGAMMA_log10)
  mutate(TARGET = ifelse(DRUG=="EMB", 100, TARGET)) %>% # add targets for those that are NA
  # mutate(MRT = case_when(LESIONNAME == "Plasma" ~ MIC_mgL,
  #                      LESIONNAME == "Lung" ~ macIC90_mgL,
  #                      LESIONNAME == "Cellular lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Cavity wall" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseous lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseum" ~ casMBC50_mgL)) %>% 
  filter(ROW_ID %in% c("TBAJ-876_50_mg_24", "PMD_200_mg_24", "LZD_600_mg_24") ) %>% 
  filter(LESIONNAME == "Plasma" & LABEL == "MIC_mgL" |
           LESIONNAME == "Caseum" & LABEL == "casMBC50_mgL_char_7") %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., tbaj876pal) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "TBAJ-876 (50 mg) + PaL")+
  theme(strip.background = element_blank(),
        legend.position = "none",
        title = element_text(size = 10))+
  scale_fill_manual(values=c("white","royalblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_TBAJ87650PaL_CorrectedRabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)
```

#TBAJ-876 + PaL (25 mg)

```{r}
## TBAJ-876 - PaL ####
tbaj876pal <- tibble(DRUG = c("TBAJ-876", "PMD",  "LZD"),
               DRUG_num = c(3,2,1))

sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>% 
  mutate(TARGET = ifelse(DRUG=="SZD-M1", 29.6, TARGET)) %>% # Ex_Vivo_Caseum_Assay.Rmd (20230726_conc-response_FIXGAMMA_log10)
  mutate(TARGET = ifelse(DRUG=="EMB", 100, TARGET)) %>% # add targets for those that are NA
  # mutate(MRT = case_when(LESIONNAME == "Plasma" ~ MIC_mgL,
  #                      LESIONNAME == "Lung" ~ macIC90_mgL,
  #                      LESIONNAME == "Cellular lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Cavity wall" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseous lesion" ~ macIC90_mgL,
  #                      LESIONNAME == "Caseum" ~ casMBC50_mgL)) %>% 
  filter(ROW_ID %in% c("TBAJ-876_25_mg_24", "PMD_200_mg_24", "LZD_600_mg_24") ) %>% 
  filter(LESIONNAME == "Plasma" & LABEL == "MIC_mgL" |
           LESIONNAME == "Caseum" & LABEL == "casMBC50_mgL_char_7") %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  mutate(LESIONNAME = case_when(LESIONNAME == "Plasma" ~ "Easy-to-treat",
                                LESIONNAME == "Caseum" ~ "Hard-to-treat")) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  left_join(., tbaj876pal) %>% 
  mutate(DRUG_LABEL = fct_reorder(DRUG_LABEL, DRUG_num)) %>% 
  ggplot(mapping = aes(x = TAD, y = DRUG, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=1, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "TBAJ-876 (25 mg) + PaL")+
  theme(strip.background = element_blank(),
        legend.position = "none",
        title = element_text(size = 10))+
  scale_fill_manual(values=c("white","royalblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_TBAJ876_25PaL_CorrectedRabbit_ONLY_byrisk.png", sep=""), width = 6, height = 1.5)
```

# BTZ

```{r}

sim_df %>% 
  filter(SPECIES == "Corrected Rabbit") %>% 
  filter(DRUG == "BTZ-043") %>% 
  filter(LABEL %in% c("MIC_mgL", "macIC90_mgL", "casMBC90_mgL")) %>%
  mutate(LABEL = case_when(LABEL == "MIC_mgL" ~ "MIC",
                           LABEL == "macIC90_mgL" ~ "macIC90",
                           LABEL == "casMBC90_mgL" ~ "casMBC90")) %>% 
  mutate(coverage_above_MRT = ifelse(CLESION > TARGET, 1, 0)) %>% 
  mutate(DRUG_LABEL = paste(DRUG,", ", DOSE, " mg ", II, sep="")) %>% 
  ggplot(mapping = aes(x = TAD, y = LABEL, fill= factor(coverage_above_MRT)))+
  geom_point(shape = 22, size = 3)+
  theme_classic()+
  scale_x_continuous(breaks = seq(0-0.5, 24-0.5,4), labels = seq(0,24,4), limits = c(0,24-1))+
  facet_wrap(~LESIONNAME, nrow=2, scales = "free")+
  labs(y = "",
       x = "Time after dose (hours)",
       title = "")+
  theme(strip.background = element_blank(),
        legend.position = "none",
        title = element_text(size = 10))+
  scale_fill_manual(values=c("white","royalblue"), name="",
                    labels=c("below target","above target"))

ggsave(plot = last_plot(), file = paste0(WD,"manuscript/figures/drafts/", format(Sys.time(), "%Y%m%d"),"_BTZ.png", sep=""), width = 6, height = 3)

```

